<div id="chart-container" style="position: relative;">
    <div class="loading" v-if="isLoading">加载中...</div>

    <div class="drawing-controls">
        <button v-if="!isDrawingToolbarExpanded" class="drawing-toggle-btn" @click="isDrawingToolbarExpanded = true" title="画线工具">✏️</button>
        <div v-else class="drawing-toolbar">
            <button class="close-btn" @click="isDrawingToolbarExpanded = false" title="收起">✕</button>
            <div class="separator"></div>
            <button :class="{ active: currentTool === 'cursor' }" @click="setTool('cursor')" title="光标">👆</button>
            <button :class="{ active: currentTool === 'line' }" @click="setTool('line')" title="直线">╱</button>
            <button :class="{ active: currentTool === 'ray' }" @click="setTool('ray')" title="射线">➚</button>
            <button :class="{ active: currentTool === 'horizontal' }" @click="setTool('horizontal')" title="横线">─</button>
            <button :class="{ active: currentTool === 'fib' }" @click="setTool('fib')" title="斐波那契回调">≡</button>
            <div style="position: relative;">
                <button :class="{ active: currentTool === 'parallel' }" @click="setTool('parallel')" title="等距通道">∥</button>
                <div v-if="currentTool === 'parallel' && showToolSettings" class="tool-settings-popup">
                    <span style="font-size: 12px; color: #d1d4dc;">条数</span>
                    <input type="number" v-model.number="parallelLevels" min="1" max="10" style="width: 40px; background: #2a2e39; color: #d1d4dc; border: 1px solid #363a45; border-radius: 2px; padding: 2px 4px; font-size: 12px; text-align: center;">
                </div>
            </div>
            <button :class="{ active: currentTool === 'delete' }" @click="toggleDeleteMode" title="删除模式 (再次点击清空)">🗑️</button>
        </div>
    </div>
    <canvas id="drawing-canvas" ref="drawingCanvas" style="position: absolute; top: 0; left: 0; z-index: 5; pointer-events: none;"></canvas>
    
        <div class="chart-error" v-if="chartError.show">
        <div class="error-content">
            <div class="error-icon">⚠️</div>
            <div class="error-title">图表加载失败</div>
            <div class="error-desc">[[ chartError.message ]]</div>
            <div class="error-detail" v-if="chartError.detail">[[ chartError.detail ]]</div>
            <button class="retry-btn" @click="retryLoad">重试</button>
        </div>
    </div>

    <div ref="chartRef" style="width: 100%; height: 100%;"></div>

    <div class="candle-tooltip" id="candle-tooltip" style="display: none;">
        <div class="tooltip-time" id="tooltip-time"></div>
        <div class="tooltip-row" id="row-open">
            <span class="tooltip-label">开盘</span>
            <span class="tooltip-value" id="tooltip-open">--</span>
        </div>
        <div class="tooltip-row" id="row-high">
            <span class="tooltip-label">最高</span>
            <span class="tooltip-value" id="tooltip-high">--</span>
        </div>
        <div class="tooltip-row" id="row-low">
            <span class="tooltip-label">最低</span>
            <span class="tooltip-value" id="tooltip-low">--</span>
        </div>
        <div class="tooltip-row">
            <span class="tooltip-label">收盘</span>
            <span class="tooltip-value" id="tooltip-close">--</span>
        </div>
        <div class="tooltip-row">
            <span class="tooltip-label">涨跌</span>
            <span class="tooltip-value" id="tooltip-change">--</span>
        </div>
        <div class="tooltip-row">
            <span class="tooltip-label">成交量</span>
            <span class="tooltip-value" id="tooltip-volume">--</span>
        </div>
    </div>
    <div id="no-data-overlay" style="position: absolute; left: 0; top: 0; bottom: 28px; width: 0; background: rgba(255, 255, 255, 0.08); border-right: 1px solid rgba(255, 255, 255, 0.2); display: none; pointer-events: none; z-index: 5; align-items: center; justify-content: center; color: rgba(255, 255, 255, 0.5); font-size: 13px; overflow: hidden; white-space: nowrap; backdrop-filter: blur(1px);">无数据</div>
</div>