<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeneticGrid - Kçº¿çœ‹ç›˜</title>
    <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        :root {
            --up-color: #26a69a;
            --down-color: #ef5350;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #131722;
            color: #d1d4dc;
            min-height: 100vh;
        }
        .header {
            background: #1e222d;
            padding: 16px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #2a2e39;
        }
        .header h1 {
            font-size: 20px;
            color: #fff;
        }
        .controls {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        .controls select, .controls button {
            background: #2a2e39;
            color: #d1d4dc;
            border: 1px solid #363a45;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
        }
        .controls select:hover, .controls button:hover {
            background: #363a45;
        }
        .ticker-info {
            display: flex;
            gap: 24px;
            padding: 12px 24px;
            background: #1e222d;
            border-bottom: 1px solid #2a2e39;
        }
        .ticker-item {
            display: flex;
            flex-direction: column;
        }
        .ticker-label {
            font-size: 12px;
            color: #787b86;
        }
        .ticker-value {
            font-size: 16px;
            font-weight: 600;
        }
        .ticker-value.up { color: var(--up-color); }
        .ticker-value.down { color: var(--down-color); }
        #chart-container {
            width: 100%;
            height: calc(100vh - 140px);
            position: relative;
        }
        /* æ‚¬åœä¿¡æ¯é¢æ¿ */
        .candle-tooltip {
            position: absolute;
            top: 12px;
            left: 12px;
            background: rgba(30, 34, 45, 0.95);
            border: 1px solid #363a45;
            border-radius: 4px;
            padding: 10px 14px;
            font-size: 13px;
            z-index: 100;
            pointer-events: none;
            min-width: 180px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .candle-tooltip.locked {
            border: 2px solid #2962ff;
            box-shadow: 0 0 10px rgba(41, 98, 255, 0.3);
        }
        .candle-tooltip.locked::before {
            content: 'ğŸ”’';
            position: absolute;
            top: 8px;
            right: 10px;
            font-size: 12px;
        }
        .candle-tooltip .tooltip-time {
            color: #787b86;
            margin-bottom: 8px;
            font-size: 12px;
        }
        .candle-tooltip .tooltip-row {
            display: flex;
            justify-content: space-between;
            margin: 4px 0;
        }
        .candle-tooltip .tooltip-label {
            color: #787b86;
        }
        .candle-tooltip .tooltip-value {
            font-weight: 500;
            margin-left: 16px;
        }
        .candle-tooltip .tooltip-value.up { color: var(--up-color); }
        .candle-tooltip .tooltip-value.down { color: var(--down-color); }
        .timeframe-buttons {
            display: flex;
            gap: 4px;
            align-items: center;
        }
        .timeframe-buttons button {
            padding: 6px 12px;
            min-width: 40px;
        }
        .timeframe-buttons button.active {
            background: #2962ff;
            border-color: #2962ff;
            color: #fff;
        }
        .timeframe-select {
            background: #2a2e39;
            color: #d1d4dc;
            border: 1px solid #363a45;
            padding: 6px 8px;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            margin-left: 8px;
        }
        .timeframe-select:hover {
            background: #363a45;
        }
        .custom-interval-input {
            background: #2a2e39;
            color: #d1d4dc;
            border: 1px solid #363a45;
            padding: 6px 8px;
            border-radius: 4px;
            font-size: 13px;
            width: 80px;
            margin-left: 8px;
            display: none;
        }
        .custom-interval-input:focus {
            outline: none;
            border-color: #2962ff;
        }
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            font-size: 18px;
            color: #787b86;
        }
        .error-banner {
            background: #ef5350;
            color: #fff;
            padding: 12px 24px;
            display: none;
            align-items: center;
            gap: 12px;
        }
        .error-banner.show {
            display: flex;
        }
        .error-banner .error-icon {
            font-size: 20px;
        }
        .error-banner .error-message {
            flex: 1;
        }
        .error-banner .error-close {
            background: none;
            border: none;
            color: #fff;
            font-size: 18px;
            cursor: pointer;
            padding: 4px 8px;
        }
        .chart-error {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            color: #ef5350;
            text-align: center;
            padding: 40px;
        }
        .chart-error .error-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }
        .chart-error .error-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        .chart-error .error-detail {
            font-size: 14px;
            color: #787b86;
            max-width: 500px;
            word-break: break-all;
        }
        .chart-error .retry-btn {
            margin-top: 20px;
            background: #2962ff;
            color: #fff;
            border: none;
            padding: 10px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .chart-error .retry-btn:hover {
            background: #1e4bd8;
        }
        .source-select {
            background: #2a2e39;
            color: #d1d4dc;
            border: 1px solid #363a45;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
        }
        .source-select:hover {
            background: #363a45;
        }
        /* ä¸‹æ‹‰èœå•æ ·å¼ */
        .dropdown {
            position: relative;
            display: inline-block;
        }
        .dropdown-content {
            display: none;
            position: absolute;
            background-color: #1e222d;
            min-width: 280px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.5);
            border: 1px solid #363a45;
            border-radius: 4px;
            z-index: 1000;
            padding: 0;
            max-height: 80vh;
            overflow-y: auto;
        }
        .dropdown-group {
            border-bottom: 1px solid #2a2e39;
        }
        .dropdown-group:last-child {
            border-bottom: none;
        }
        .dropdown-group-title {
            padding: 8px 16px;
            font-size: 12px;
            color: #787b86;
            font-weight: 600;
            background: #252933;
        }
        .dropdown-item {
            padding: 8px 16px;
            display: flex;
            align-items: center;
            cursor: pointer;
            color: #d1d4dc;
            font-size: 13px;
            justify-content: space-between;
        }
        .dropdown-item:hover {
            background-color: #2a2e39;
        }
        .dropdown-item label {
            display: flex;
            align-items: center;
            cursor: pointer;
            flex: 1;
        }
        .dropdown-item input {
            margin-right: 8px;
        }
        .info-icon {
            color: #787b86;
            font-size: 12px;
            cursor: help;
            margin-left: 8px;
            border: 1px solid #787b86;
            border-radius: 50%;
            width: 14px;
            height: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .info-icon:hover {
            color: #d1d4dc;
            border-color: #d1d4dc;
        }
        .source-label {
            font-size: 12px;
            color: #787b86;
            margin-right: 4px;
        }
        
        /* è®¾ç½®æ¨¡æ€æ¡† */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-overlay.show {
            display: flex;
        }
        .modal {
            background: #1e222d;
            border: 1px solid #363a45;
            border-radius: 6px;
            width: 400px;
            max-width: 90%;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        }
        .modal-header {
            padding: 16px 20px;
            border-bottom: 1px solid #2a2e39;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-title {
            font-size: 16px;
            font-weight: 600;
            color: #d1d4dc;
        }
        .modal-close {
            background: none;
            border: none;
            color: #787b86;
            font-size: 20px;
            cursor: pointer;
            padding: 0;
        }
        .modal-close:hover {
            color: #d1d4dc;
        }
        .modal-body {
            padding: 20px;
        }
        .setting-item {
            margin-bottom: 20px;
        }
        .setting-label {
            display: block;
            margin-bottom: 8px;
            color: #d1d4dc;
            font-size: 14px;
        }
        .setting-options {
            display: flex;
            gap: 10px;
        }
        .radio-label {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            color: #787b86;
            font-size: 14px;
        }
        .radio-label input {
            margin: 0;
        }
        .radio-label:hover {
            color: #d1d4dc;
        }
        .color-preview {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 2px;
            margin-right: 4px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ§¬ GeneticGrid çœ‹ç›˜</h1>
        <div class="controls">
            <select id="symbol-select">
                <option value="BTC-USDT">BTC/USDT</option>
                <option value="ETH-USDT">ETH/USDT</option>
                <option value="SOL-USDT">SOL/USDT</option>
                <option value="XRP-USDT">XRP/USDT</option>
                <option value="DOGE-USDT">DOGE/USDT</option>
                <option value="ADA-USDT">ADA/USDT</option>
                <option value="AVAX-USDT">AVAX/USDT</option>
                <option value="LINK-USDT">LINK/USDT</option>
            </select>
            <div class="timeframe-buttons">
                <button data-bar="1m">1åˆ†</button>
                <button data-bar="5m">5åˆ†</button>
                <button data-bar="15m">15åˆ†</button>
                <button data-bar="1H" class="active">1æ—¶</button>
                <button data-bar="4H">4æ—¶</button>
                <button data-bar="1D">æ—¥çº¿</button>
                <select id="more-timeframes" class="timeframe-select">
                    <option value="">æ›´å¤šå‘¨æœŸ...</option>
                    <option value="tick">åˆ†æ—¶</option>
                    <option value="1s">1ç§’</option>
                    <option value="5s">5ç§’</option>
                    <option value="15s">15ç§’</option>
                    <option value="30s">30ç§’</option>
                    <option value="1m">1åˆ†</option>
                    <option value="3m">3åˆ†</option>
                    <option value="5m">5åˆ†</option>
                    <option value="15m">15åˆ†</option>
                    <option value="30m">30åˆ†</option>
                    <option value="1H">1æ—¶</option>
                    <option value="3H">3æ—¶</option>
                    <option value="6H">6æ—¶</option>
                    <option value="12H">12æ—¶</option>
                    <option value="1D">1æ—¥</option>
                    <option value="3D">3æ—¥</option>
                    <option value="5D">5æ—¥</option>
                    <option value="1W">1å‘¨</option>
                    <option value="1M">1æœˆ</option>
                    <option value="3M">3æœˆ</option>
                    <option value="custom">è‡ªå®šä¹‰...</option>
                </select>
                <input type="text" id="custom-interval" class="custom-interval-input" placeholder="å¦‚: 2H, 7D">
            </div>
            
            <div class="dropdown">
                <button>æŒ‡æ ‡ â–¼</button>
                <div class="dropdown-content">
                    <div class="dropdown-group">
                        <div class="dropdown-group-title">ä¸»å›¾æŒ‡æ ‡ (å åŠ )</div>
                        <div class="dropdown-item">
                            <label><input type="checkbox" id="ind-ma" onchange="toggleMainIndicator('ma')"> MA (ç§»åŠ¨å¹³å‡çº¿)</label>
                            <span class="info-icon" title="Moving Average: ç®€å•ç§»åŠ¨å¹³å‡çº¿ï¼Œæ˜¾ç¤ºè¿‡å»Nå¤©çš„å¹³å‡ä»·æ ¼è¶‹åŠ¿ã€‚">?</span>
                        </div>
                        <div class="dropdown-item">
                            <label><input type="checkbox" id="ind-ema" onchange="toggleMainIndicator('ema')"> EMA (æŒ‡æ•°ç§»åŠ¨å¹³å‡)</label>
                            <span class="info-icon" title="Exponential Moving Average: æŒ‡æ•°ç§»åŠ¨å¹³å‡çº¿ï¼Œå¯¹è¿‘æœŸä»·æ ¼èµ‹äºˆæ›´å¤§æƒé‡ã€‚">?</span>
                        </div>
                        <div class="dropdown-item">
                            <label><input type="checkbox" id="ind-boll" onchange="toggleMainIndicator('boll')"> BOLL (å¸ƒæ—å¸¦)</label>
                            <span class="info-icon" title="Bollinger Bands: åˆ©ç”¨æ ‡å‡†å·®è®¡ç®—å‡ºçš„ä»·æ ¼é€šé“ï¼Œåæ˜ ä»·æ ¼æ³¢åŠ¨ç‡ã€‚">?</span>
                        </div>
                        <div class="dropdown-item">
                            <label><input type="checkbox" id="ind-sar" onchange="toggleMainIndicator('sar')"> SAR (æŠ›ç‰©çº¿è½¬å‘)</label>
                            <span class="info-icon" title="Parabolic SAR: åœæŸç‚¹è½¬å‘æŒ‡æ ‡ï¼Œç”¨äºåˆ¤æ–­è¶‹åŠ¿åè½¬ç‚¹ã€‚">?</span>
                        </div>
                        <div class="dropdown-item">
                            <label><input type="checkbox" id="ind-supertrend" onchange="toggleMainIndicator('supertrend')"> SuperTrend (è¶…çº§è¶‹åŠ¿)</label>
                            <span class="info-icon" title="SuperTrend: åŸºäºATRçš„è¶‹åŠ¿è·Ÿè¸ªæŒ‡æ ‡ï¼Œæ˜¾ç¤ºå½“å‰è¶‹åŠ¿æ–¹å‘å’Œæ”¯æ’‘/é˜»åŠ›ä½ã€‚">?</span>
                        </div>
                        <div class="dropdown-item">
                            <label><input type="checkbox" id="ind-sr" onchange="toggleMainIndicator('sr')"> Support/Resistance (æ’‘å‹çº¿)</label>
                            <span class="info-icon" title="Support & Resistance: è‡ªåŠ¨è¯†åˆ«è¿‘æœŸçš„æ”¯æ’‘ä½å’Œé˜»åŠ›ä½ã€‚">?</span>
                        </div>
                    </div>
                    
                    <div class="dropdown-group">
                        <div class="dropdown-group-title">å‰¯å›¾æŒ‡æ ‡ (å•é€‰)</div>
                        <div class="dropdown-item">
                            <label><input type="radio" name="sub-ind" value="none" checked onchange="switchSubIndicator('none')"> æ— </label>
                        </div>
                        <div class="dropdown-item">
                            <label><input type="radio" name="sub-ind" value="macd" onchange="switchSubIndicator('macd')"> MACD (æŒ‡æ•°å¹³æ»‘å¼‚åŒ)</label>
                            <span class="info-icon" title="MACD: è¶‹åŠ¿è·Ÿè¸ªåŠ¨é‡æŒ‡æ ‡ï¼Œæ˜¾ç¤ºä¸¤æ¡ç§»åŠ¨å¹³å‡çº¿ä¹‹é—´çš„å…³ç³»ã€‚">?</span>
                        </div>
                        <div class="dropdown-item">
                            <label><input type="radio" name="sub-ind" value="kdj" onchange="switchSubIndicator('kdj')"> KDJ (éšæœºæŒ‡æ ‡)</label>
                            <span class="info-icon" title="KDJ: éšæœºéœ‡è¡æŒ‡æ ‡ï¼Œç”¨äºåˆ¤æ–­è¶…ä¹°è¶…å–ã€‚">?</span>
                        </div>
                        <div class="dropdown-item">
                            <label><input type="radio" name="sub-ind" value="rsi" onchange="switchSubIndicator('rsi')"> RSI (ç›¸å¯¹å¼ºå¼±æŒ‡æ•°)</label>
                            <span class="info-icon" title="RSI: è¡¡é‡ä»·æ ¼å˜åŠ¨çš„é€Ÿåº¦å’Œå˜åŒ–ï¼Œåˆ¤æ–­è¶…ä¹°è¶…å–ã€‚">?</span>
                        </div>
                        <div class="dropdown-item">
                            <label><input type="radio" name="sub-ind" value="stochrsi" onchange="switchSubIndicator('stochrsi')"> StochRSI (éšæœºRSI)</label>
                            <span class="info-icon" title="Stochastic RSI: å°†éšæœºæŒ‡æ ‡å…¬å¼åº”ç”¨äºRSIå€¼ï¼Œæ›´çµæ•ã€‚">?</span>
                        </div>
                        <div class="dropdown-item">
                            <label><input type="radio" name="sub-ind" value="cci" onchange="switchSubIndicator('cci')"> CCI (é¡ºåŠ¿æŒ‡æ ‡)</label>
                            <span class="info-icon" title="CCI: è¡¡é‡å½“å‰ä»·æ ¼ä¸å…¶å†å²å¹³å‡ä»·æ ¼çš„åç¦»ç¨‹åº¦ã€‚">?</span>
                        </div>
                        <div class="dropdown-item">
                            <label><input type="radio" name="sub-ind" value="dmi" onchange="switchSubIndicator('dmi')"> DMI (åŠ¨å‘æŒ‡æ ‡)</label>
                            <span class="info-icon" title="DMI: è¯†åˆ«è¶‹åŠ¿çš„å­˜åœ¨å’Œå¼ºåº¦ã€‚">?</span>
                        </div>
                        <div class="dropdown-item">
                            <label><input type="radio" name="sub-ind" value="wr" onchange="switchSubIndicator('wr')"> WR (å¨å»‰æŒ‡æ ‡)</label>
                            <span class="info-icon" title="Williams %R: åŠ¨é‡æŒ‡æ ‡ï¼Œè¡¡é‡è¶…ä¹°è¶…å–æ°´å¹³ã€‚">?</span>
                        </div>
                        <div class="dropdown-item">
                            <label><input type="radio" name="sub-ind" value="obv" onchange="switchSubIndicator('obv')"> OBV (èƒ½é‡æ½®)</label>
                            <span class="info-icon" title="On-Balance Volume: é€šè¿‡æˆäº¤é‡å˜åŒ–é¢„æµ‹ä»·æ ¼è¶‹åŠ¿ã€‚">?</span>
                        </div>
                        <div class="dropdown-item">
                            <label><input type="radio" name="sub-ind" value="trix" onchange="switchSubIndicator('trix')"> TRIX (ä¸‰é‡æŒ‡æ•°å¹³æ»‘)</label>
                            <span class="info-icon" title="TRIX: è¿‡æ»¤çŸ­æœŸæ³¢åŠ¨ï¼Œæ˜¾ç¤ºé•¿æœŸè¶‹åŠ¿ã€‚">?</span>
                        </div>
                        <div class="dropdown-item">
                            <label><input type="radio" name="sub-ind" value="roc" onchange="switchSubIndicator('roc')"> ROC (å˜åŠ¨ç‡)</label>
                            <span class="info-icon" title="Rate of Change: è¡¡é‡ä»·æ ¼å˜åŒ–çš„ç™¾åˆ†æ¯”ã€‚">?</span>
                        </div>
                        <div class="dropdown-item">
                            <label><input type="radio" name="sub-ind" value="mtm" onchange="switchSubIndicator('mtm')"> MTM (åŠ¨é‡æŒ‡æ ‡)</label>
                            <span class="info-icon" title="Momentum: è¡¡é‡ä»·æ ¼å˜åŒ–çš„é€Ÿåº¦ã€‚">?</span>
                        </div>
                        <div class="dropdown-item">
                            <label><input type="radio" name="sub-ind" value="dma" onchange="switchSubIndicator('dma')"> DMA (å¹³å‡çº¿å·®)</label>
                            <span class="info-icon" title="DMA: åˆ©ç”¨ä¸¤æ¡ä¸åŒæœŸé—´çš„å¹³å‡çº¿å·®å€¼åˆ¤æ–­è¶‹åŠ¿ã€‚">?</span>
                        </div>
                        <div class="dropdown-item">
                            <label><input type="radio" name="sub-ind" value="vr" onchange="switchSubIndicator('vr')"> VR (æˆäº¤é‡æ¯”ç‡)</label>
                            <span class="info-icon" title="Volume Ratio: é€šè¿‡æˆäº¤é‡æ¯”ç‡åˆ†æå¸‚åœºæ°”æ°›ã€‚">?</span>
                        </div>
                        <div class="dropdown-item">
                            <label><input type="radio" name="sub-ind" value="brar" onchange="switchSubIndicator('brar')"> BRAR (æƒ…ç»ªæŒ‡æ ‡)</label>
                            <span class="info-icon" title="BRAR: äººæ°”æ„æ„¿æŒ‡æ ‡ï¼Œåæ˜ å¸‚åœºä¹°å–æ„æ„¿ã€‚">?</span>
                        </div>
                        <div class="dropdown-item">
                            <label><input type="radio" name="sub-ind" value="psy" onchange="switchSubIndicator('psy')"> PSY (å¿ƒç†çº¿)</label>
                            <span class="info-icon" title="Psychological Line: ç ”ç©¶æŠ•èµ„è€…å¿ƒç†æ³¢åŠ¨çš„æƒ…ç»ªæŒ‡æ ‡ã€‚">?</span>
                        </div>
                    </div>

                    <div class="dropdown-group">
                        <div class="dropdown-group-title">å…¶ä»–</div>
                        <div class="dropdown-item">
                            <label><input type="checkbox" id="ind-vol" checked onchange="toggleMainIndicator('vol')"> VOL (æˆäº¤é‡)</label>
                            <span class="info-icon" title="Volume: äº¤æ˜“é‡ã€‚">?</span>
                        </div>
                    </div>
                </div>
            </div>

            <span class="source-label">æ•°æ®æº:</span>
            <select id="source-select" class="source-select">
                <option value="binance">Binance</option>
                <option value="coingecko">CoinGecko</option>
                <option value="okx">OKX</option>
            </select>
            <button id="refresh-btn">ğŸ”„ åˆ·æ–°</button>
            <button id="settings-btn" title="è®¾ç½®">âš™ï¸</button>
        </div>
    </div>

    <div class="error-banner" id="error-banner">
        <span class="error-icon">âš ï¸</span>
        <span class="error-message" id="error-message"></span>
        <button class="error-close" onclick="hideError()">âœ•</button>
    </div>

    <div class="ticker-info">
        <div class="ticker-item">
            <span class="ticker-label">æœ€æ–°ä»·</span>
            <span class="ticker-value" id="last-price">--</span>
        </div>
        <div class="ticker-item">
            <span class="ticker-label">24hæ¶¨è·Œ</span>
            <span class="ticker-value" id="change-24h">--</span>
        </div>
        <div class="ticker-item">
            <span class="ticker-label">24hæœ€é«˜</span>
            <span class="ticker-value" id="high-24h">--</span>
        </div>
        <div class="ticker-item">
            <span class="ticker-label">24hæœ€ä½</span>
            <span class="ticker-value" id="low-24h">--</span>
        </div>
        <div class="ticker-item">
            <span class="ticker-label">24hæˆäº¤é‡</span>
            <span class="ticker-value" id="volume-24h">--</span>
        </div>
    </div>

    <div id="chart-container">
        <div class="loading">åŠ è½½ä¸­...</div>
        <div class="candle-tooltip" id="candle-tooltip" style="display: none;">
            <div class="tooltip-time" id="tooltip-time"></div>
            <div class="tooltip-row">
                <span class="tooltip-label">å¼€ç›˜</span>
                <span class="tooltip-value" id="tooltip-open">--</span>
            </div>
            <div class="tooltip-row">
                <span class="tooltip-label">æœ€é«˜</span>
                <span class="tooltip-value" id="tooltip-high">--</span>
            </div>
            <div class="tooltip-row">
                <span class="tooltip-label">æœ€ä½</span>
                <span class="tooltip-value" id="tooltip-low">--</span>
            </div>
            <div class="tooltip-row">
                <span class="tooltip-label">æ”¶ç›˜</span>
                <span class="tooltip-value" id="tooltip-close">--</span>
            </div>
            <div class="tooltip-row">
                <span class="tooltip-label">æ¶¨è·Œ</span>
                <span class="tooltip-value" id="tooltip-change">--</span>
            </div>
            <div class="tooltip-row">
                <span class="tooltip-label">æˆäº¤é‡</span>
                <span class="tooltip-value" id="tooltip-volume">--</span>
            </div>
        </div>
    </div>

    <!-- è®¾ç½®æ¨¡æ€æ¡† -->
    <div class="modal-overlay" id="settings-modal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">åå¥½è®¾ç½®</div>
                <button class="modal-close" onclick="toggleSettings()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="setting-item">
                    <span class="setting-label">æ¶¨è·Œé¢œè‰²</span>
                    <div class="setting-options">
                        <label class="radio-label">
                            <input type="radio" name="color-scheme" value="green-up" checked onchange="changeColorScheme('green-up')">
                            <span><span class="color-preview" style="background:#26a69a"></span>ç»¿æ¶¨<span class="color-preview" style="background:#ef5350; margin-left:4px"></span>çº¢è·Œ</span>
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="color-scheme" value="red-up" onchange="changeColorScheme('red-up')">
                            <span><span class="color-preview" style="background:#ef5350"></span>çº¢æ¶¨<span class="color-preview" style="background:#26a69a; margin-left:4px"></span>ç»¿è·Œ</span>
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let chart = null;
        let candleSeries = null;
        let volumeSeries = null;
        let highlightSeries = null;
        let currentSymbol = '{{ inst_id }}';
        let currentBar = '{{ bar }}';
        let currentSource = '{{ source }}';
        
        // æŒ‡æ ‡çŠ¶æ€å’ŒSeries
        const indicators = {
            // ä¸»å›¾æŒ‡æ ‡
            vol: { enabled: true, series: null },
            ma: { enabled: false, series: [] },
            ema: { enabled: false, series: [] },
            boll: { enabled: false, series: [] },
            sar: { enabled: false, series: [] },
            supertrend: { enabled: false, series: [] },
            sr: { enabled: false, series: [] },
            
            // å‰¯å›¾æŒ‡æ ‡ (å½“å‰é€‰ä¸­çš„å‰¯å›¾æŒ‡æ ‡åç§°)
            activeSubIndicator: 'none',
            subSeries: [] // å­˜å‚¨å½“å‰å‰¯å›¾æŒ‡æ ‡çš„æ‰€æœ‰ Series
        };

        // é¢œè‰²é…ç½®
        const COLORS = {
            GREEN: '#26a69a',
            RED: '#ef5350',
            GREEN_TRANSPARENT: '#26a69a80',
            RED_TRANSPARENT: '#ef535080'
        };
        
        // åå¥½è®¾ç½®
        let settings = {
            colorScheme: localStorage.getItem('geneticgrid_color_scheme') || 'green-up' // 'green-up' or 'red-up'
        };

        // è·å–å½“å‰é¢œè‰²é…ç½®
        function getColors() {
            if (settings.colorScheme === 'green-up') {
                return {
                    up: COLORS.GREEN,
                    down: COLORS.RED,
                    upTransparent: COLORS.GREEN_TRANSPARENT,
                    downTransparent: COLORS.RED_TRANSPARENT
                };
            } else {
                return {
                    up: COLORS.RED,
                    down: COLORS.GREEN,
                    upTransparent: COLORS.RED_TRANSPARENT,
                    downTransparent: COLORS.GREEN_TRANSPARENT
                };
            }
        }

        // åº”ç”¨é¢œè‰²è®¾ç½®
        function applyColorScheme() {
            const colors = getColors();
            const root = document.documentElement;
            
            // æ›´æ–° CSS å˜é‡
            root.style.setProperty('--up-color', colors.up);
            root.style.setProperty('--down-color', colors.down);
            
            // æ›´æ–°å•é€‰æ¡†çŠ¶æ€
            const radios = document.getElementsByName('color-scheme');
            for (let radio of radios) {
                if (radio.value === settings.colorScheme) {
                    radio.checked = true;
                }
            }

            // å¦‚æœå›¾è¡¨å·²åˆå§‹åŒ–ï¼Œæ›´æ–°å›¾è¡¨é…ç½®
            if (candleSeries) {
                candleSeries.applyOptions({
                    upColor: colors.up,
                    downColor: colors.down,
                    borderDownColor: colors.down,
                    borderUpColor: colors.up,
                    wickDownColor: colors.down,
                    wickUpColor: colors.up,
                });
                
                // é‡æ–°æ¸²æŸ“æ•°æ®ä»¥æ›´æ–°æˆäº¤é‡é¢œè‰²
                if (allCandles.length > 0) {
                    updateChartData();
                }
            }
        }

        // åˆ‡æ¢è®¾ç½®æ¨¡æ€æ¡†
        function toggleSettings() {
            const modal = document.getElementById('settings-modal');
            if (modal.classList.contains('show')) {
                modal.classList.remove('show');
            } else {
                modal.classList.add('show');
            }
        }

        // æ›´æ”¹é¢œè‰²æ–¹æ¡ˆ
        function changeColorScheme(scheme) {
            settings.colorScheme = scheme;
            localStorage.setItem('geneticgrid_color_scheme', scheme);
            applyColorScheme();
        }

        // åˆå§‹åŒ–æ—¶åº”ç”¨è®¾ç½®
        document.addEventListener('DOMContentLoaded', () => {
            applyColorScheme();
            
            // ç»‘å®šè®¾ç½®æŒ‰é’®äº‹ä»¶
            document.getElementById('settings-btn').addEventListener('click', toggleSettings);
            
            // ç‚¹å‡»é®ç½©å±‚å…³é—­
            document.getElementById('settings-modal').addEventListener('click', (e) => {
                if (e.target.id === 'settings-modal') {
                    toggleSettings();
                }
            });
        });

        // æ•°æ®ç¼“å­˜
        let allCandles = [];
        let isLoadingMore = false;
        let isLoadingNewer = false;
        let oldestTimestamp = null;
        let newestTimestamp = null;
        let hasMoreData = true;
        let hasNewerData = true;
        
        // Tooltip é”å®šçŠ¶æ€
        let isTooltipLocked = false;
        let lockedCandleTime = null;

        // åˆå§‹åŒ–å›¾è¡¨
        function initChart() {
            const container = document.getElementById('chart-container');
            
            // åªç§»é™¤å›¾è¡¨ï¼Œä¿ç•™ tooltip
            const existingTooltip = document.getElementById('candle-tooltip');
            container.innerHTML = '';
            
            // é‡æ–°æ·»åŠ  tooltip
            if (!existingTooltip) {
                const tooltip = document.createElement('div');
                tooltip.className = 'candle-tooltip';
                tooltip.id = 'candle-tooltip';
                tooltip.style.display = 'none';
                tooltip.innerHTML = `
                    <div class="tooltip-time" id="tooltip-time"></div>
                    <div class="tooltip-row">
                        <span class="tooltip-label">å¼€ç›˜</span>
                        <span class="tooltip-value" id="tooltip-open">--</span>
                    </div>
                    <div class="tooltip-row">
                        <span class="tooltip-label">æœ€é«˜</span>
                        <span class="tooltip-value" id="tooltip-high">--</span>
                    </div>
                    <div class="tooltip-row">
                        <span class="tooltip-label">æœ€ä½</span>
                        <span class="tooltip-value" id="tooltip-low">--</span>
                    </div>
                    <div class="tooltip-row">
                        <span class="tooltip-label">æ”¶ç›˜</span>
                        <span class="tooltip-value" id="tooltip-close">--</span>
                    </div>
                    <div class="tooltip-row">
                        <span class="tooltip-label">æ¶¨è·Œ</span>
                        <span class="tooltip-value" id="tooltip-change">--</span>
                    </div>
                    <div class="tooltip-row">
                        <span class="tooltip-label">æˆäº¤é‡</span>
                        <span class="tooltip-value" id="tooltip-volume">--</span>
                    </div>
                `;
                container.appendChild(tooltip);
            } else {
                container.appendChild(existingTooltip);
            }
            
            // é‡ç½®æ•°æ®çŠ¶æ€
            allCandles = [];
            oldestTimestamp = null;
            newestTimestamp = null;
            hasMoreData = true;
            hasNewerData = true;
            isLoadingMore = false;
            isLoadingNewer = false;

            // é‡ç½®æŒ‡æ ‡ Series å¼•ç”¨ï¼Œå› ä¸º chart å°†è¢«é‡å»º
            indicators.vol.series = null;
            indicators.ma.series = [];
            indicators.ema.series = [];
            indicators.boll.series = [];

            chart = LightweightCharts.createChart(container, {
                layout: {
                    background: { type: 'solid', color: '#131722' },
                    textColor: '#d1d4dc',
                },
                grid: {
                    vertLines: { color: '#1e222d' },
                    horzLines: { color: '#1e222d' },
                },
                crosshair: {
                    mode: LightweightCharts.CrosshairMode.Normal,
                },
                rightPriceScale: {
                    borderColor: '#2a2e39',
                },
                timeScale: {
                    borderColor: '#2a2e39',
                    timeVisible: true,
                    secondsVisible: false,
                },
            });

            const colors = getColors();

            // Kçº¿åºåˆ—
            candleSeries = chart.addCandlestickSeries({
                upColor: colors.up,
                downColor: colors.down,
                borderDownColor: colors.down,
                borderUpColor: colors.up,
                wickDownColor: colors.down,
                wickUpColor: colors.up,
            });

            // æˆäº¤é‡åºåˆ—
            volumeSeries = chart.addHistogramSeries({
                color: colors.up,
                priceFormat: {
                    type: 'volume',
                },
                priceScaleId: '',
            });
            volumeSeries.priceScale().applyOptions({
                scaleMargins: {
                    top: 0.8,
                    bottom: 0,
                },
            });
            // åº”ç”¨ VOL çŠ¶æ€
            volumeSeries.applyOptions({ visible: indicators.vol.enabled });
            indicators.vol.series = volumeSeries;
            
            // åˆ›å»ºç”¨äºæ ‡è®°é€‰ä¸­èœ¡çƒ›çš„ç³»åˆ—
            markerSeries = chart.addLineSeries({
                color: 'transparent',
                lineWidth: 0,
                priceLineVisible: false,
                lastValueVisible: false,
                crosshairMarkerVisible: false,
            });
            
            // åˆ›å»ºç”¨äºé«˜äº®é€‰ä¸­èœ¡çƒ›çš„ç³»åˆ—ï¼ˆç™½è‰²è¾¹æ¡†ï¼‰
            highlightSeries = chart.addCandlestickSeries({
                upColor: 'transparent',
                downColor: 'transparent',
                borderUpColor: '#ffffff',
                borderDownColor: '#ffffff',
                wickUpColor: '#ffffff',
                wickDownColor: '#ffffff',
                borderVisible: true,
                priceLineVisible: false,
                lastValueVisible: false,
            });

            // è‡ªé€‚åº”å¤§å°
            new ResizeObserver(entries => {
                if (entries.length === 0 || entries[0].target !== container) return;
                const { width, height } = entries[0].contentRect;
                chart.applyOptions({ width, height });
            }).observe(container);
            
            // ç›‘å¬å¯è§èŒƒå›´å˜åŒ–ï¼ŒåŠ è½½æ›´å¤šå†å²æ•°æ®
            chart.timeScale().subscribeVisibleLogicalRangeChange(onVisibleRangeChange);
            
            // ç›‘å¬åå­—çº¿ç§»åŠ¨ï¼Œæ˜¾ç¤ºæ‚¬åœä¿¡æ¯
            chart.subscribeCrosshairMove(onCrosshairMove);
            
            // ç›‘å¬ç‚¹å‡»äº‹ä»¶ï¼Œé”å®š/è§£é”tooltip
            chart.subscribeClick(onChartClick);
        }
        
        // ç‚¹å‡»å›¾è¡¨æ—¶é”å®š/è§£é”tooltip
        function onChartClick(param) {
            if (!param || !param.time) {
                // ç‚¹å‡»ç©ºç™½åŒºåŸŸï¼Œè§£é”tooltip
                isTooltipLocked = false;
                lockedCandleTime = null;
                const tooltip = document.getElementById('candle-tooltip');
                if (tooltip) {
                    tooltip.classList.remove('locked');
                }
                // æ¸…é™¤é«˜äº®
                if (highlightSeries) {
                    highlightSeries.setData([]);
                }
                return;
            }
            
            const candleData = param.seriesData.get(candleSeries);
            if (!candleData) {
                return;
            }
            
            // å¦‚æœç‚¹å‡»çš„æ˜¯å·²é”å®šçš„èœ¡çƒ›ï¼Œè§£é”
            if (isTooltipLocked && lockedCandleTime === param.time) {
                isTooltipLocked = false;
                lockedCandleTime = null;
                const tooltip = document.getElementById('candle-tooltip');
                if (tooltip) {
                    tooltip.classList.remove('locked');
                }
                // æ¸…é™¤é«˜äº®
                if (highlightSeries) {
                    highlightSeries.setData([]);
                }
            } else {
                // é”å®šåˆ°æ–°çš„èœ¡çƒ›
                isTooltipLocked = true;
                lockedCandleTime = param.time;
                const tooltip = document.getElementById('candle-tooltip');
                if (tooltip) {
                    tooltip.classList.add('locked');
                }
                // æ·»åŠ ç™½è‰²è¾¹æ¡†é«˜äº®
                if (highlightSeries) {
                    highlightSeries.setData([{
                        time: param.time,
                        open: candleData.open,
                        high: candleData.high,
                        low: candleData.low,
                        close: candleData.close
                    }]);
                }
                // æ›´æ–°tooltipå†…å®¹
                updateTooltipContent(param);
            }
        }
        
        // åå­—çº¿ç§»åŠ¨æ—¶æ˜¾ç¤º K çº¿ä¿¡æ¯
        function onCrosshairMove(param) {
            // å¦‚æœtooltipå·²é”å®šï¼Œä¸å“åº”æ‚¬åœ
            if (isTooltipLocked) {
                return;
            }
            
            const tooltip = document.getElementById('candle-tooltip');
            
            // æ£€æŸ¥ tooltip å…ƒç´ æ˜¯å¦å­˜åœ¨
            if (!tooltip) {
                return;
            }
            
            if (!param || !param.time || param.point === undefined || 
                param.point.x < 0 || param.point.y < 0) {
                tooltip.style.display = 'none';
                return;
            }
            
            updateTooltipContent(param);
        }
        
        // æ›´æ–°tooltipå†…å®¹çš„é€šç”¨å‡½æ•°
        function updateTooltipContent(param) {
            const tooltip = document.getElementById('candle-tooltip');
            if (!tooltip) return;
            
            const candleData = param.seriesData.get(candleSeries);
            const volumeData = param.seriesData.get(volumeSeries);
            
            if (!candleData) {
                if (!isTooltipLocked) {
                    tooltip.style.display = 'none';
                }
                return;
            }
            
            // æ ¼å¼åŒ–æ—¶é—´
            const date = new Date(param.time * 1000);
            const timeStr = date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            // è®¡ç®—æ¶¨è·Œå¹…
            const change = candleData.close - candleData.open;
            const changePercent = ((change / candleData.open) * 100).toFixed(2);
            const isUp = change >= 0;
            const colorClass = isUp ? 'up' : 'down';
            
            // æ ¼å¼åŒ–æ•°å­—
            const formatNum = (num) => {
                if (num >= 1000) return num.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                if (num >= 1) return num.toFixed(4);
                return num.toPrecision(4);
            };
            
            const formatVolume = (vol) => {
                if (vol >= 1e9) return (vol / 1e9).toFixed(2) + 'B';
                if (vol >= 1e6) return (vol / 1e6).toFixed(2) + 'M';
                if (vol >= 1e3) return (vol / 1e3).toFixed(2) + 'K';
                return vol.toFixed(2);
            };
            
            // è·å–æ‰€æœ‰ tooltip å­å…ƒç´ å¹¶æ£€æŸ¥æ˜¯å¦å­˜åœ¨
            const timeEl = document.getElementById('tooltip-time');
            const openEl = document.getElementById('tooltip-open');
            const highEl = document.getElementById('tooltip-high');
            const lowEl = document.getElementById('tooltip-low');
            const closeEl = document.getElementById('tooltip-close');
            const changeEl = document.getElementById('tooltip-change');
            const volumeEl = document.getElementById('tooltip-volume');
            
            // å¦‚æœä»»ä½•å…ƒç´ ä¸å­˜åœ¨ï¼Œç›´æ¥è¿”å›
            if (!timeEl || !openEl || !highEl || !lowEl || !closeEl || !changeEl || !volumeEl) {
                return;
            }
            
            // æ›´æ–° tooltip å†…å®¹
            timeEl.textContent = timeStr;
            openEl.textContent = formatNum(candleData.open);
            highEl.textContent = formatNum(candleData.high);
            lowEl.textContent = formatNum(candleData.low);
            
            closeEl.textContent = formatNum(candleData.close);
            closeEl.className = `tooltip-value ${colorClass}`;
            
            changeEl.textContent = `${isUp ? '+' : ''}${changePercent}%`;
            changeEl.className = `tooltip-value ${colorClass}`;
            
            const volume = volumeData ? volumeData.value : (candleData.volume || 0);
            volumeEl.textContent = formatVolume(volume);
            
            tooltip.style.display = 'block';
        }
        
        // å¯è§èŒƒå›´å˜åŒ–æ—¶æ£€æŸ¥æ˜¯å¦éœ€è¦åŠ è½½æ›´å¤šæ•°æ®
        function onVisibleRangeChange(logicalRange) {
            if (!logicalRange) return;
            
            const dataLength = allCandles.length;
            if (dataLength === 0) return;
            
            // æ£€æŸ¥å·¦ä¾§ï¼ˆå†å²æ•°æ®ï¼‰- æ›´æ¿€è¿›çš„ç­–ç•¥ï¼Œç¡®ä¿å§‹ç»ˆæœ‰è¶³å¤Ÿæ•°æ®
            // å½“å¯è§èŒƒå›´çš„èµ·å§‹ä½ç½®æ¥è¿‘å·²åŠ è½½æ•°æ®çš„è¾¹ç•Œæ—¶ï¼Œç«‹å³åŠ è½½æ›´å¤š
            if (logicalRange.from < 500 && hasMoreData && !isLoadingMore) {
                // ç«‹å³è§¦å‘åŠ è½½
                loadMoreHistoryUntilEnough(logicalRange);
            }
            
            // æ£€æŸ¥å³ä¾§ï¼ˆæ›´æ–°æ•°æ®ï¼‰
            if (logicalRange.to > dataLength - 500 && hasNewerData && !isLoadingNewer) {
                loadMoreNewerUntilEnough(logicalRange);
            }
        }
        
        // æŒç»­åŠ è½½å†å²æ•°æ®ç›´åˆ°ç¼“å†²åŒºè¶³å¤Ÿ
        async function loadMoreHistoryUntilEnough(logicalRange) {
            if (isLoadingMore || !hasMoreData) return;
            
            isLoadingMore = true;
            let loadedCount = 0;
            const targetBuffer = 2000; // è¿›ä¸€æ­¥å¢åŠ ç›®æ ‡ç¼“å†²åŒºåˆ°2000æ¡ï¼ˆçº¦33å°æ—¶çš„1åˆ†é’Ÿæ•°æ®ï¼‰
            
            try {
                // æŒç»­åŠ è½½ç›´åˆ°ç¼“å†²åŒºè¶³å¤Ÿæˆ–æ²¡æœ‰æ›´å¤šæ•°æ®
                while (hasMoreData && loadedCount < targetBuffer) {
                    const beforeTs = oldestTimestamp * 1000;
                    const url = `/api/candlesticks/?symbol=${currentSymbol}&bar=${currentBar}&limit=500&source=${currentSource}&before=${beforeTs}`;
                    const response = await fetch(url);
                    const result = await response.json();
                    
                    if (result.code === 0 && result.data && result.data.length > 0) {
                        const newCandles = result.data;
                        
                        // è¿‡æ»¤æ‰å·²å­˜åœ¨çš„æ•°æ®
                        const existingTimes = new Set(allCandles.map(c => c.time));
                        const uniqueNewCandles = newCandles.filter(c => !existingTimes.has(c.time));
                        
                        if (uniqueNewCandles.length > 0) {
                            allCandles = [...uniqueNewCandles, ...allCandles];
                            allCandles.sort((a, b) => a.time - b.time);
                            oldestTimestamp = allCandles[0].time;
                            loadedCount += uniqueNewCandles.length;
                            
                            // æ¯æ¬¡åŠ è½½åæ›´æ–°å›¾è¡¨
                            updateChartData();
                        } else {
                            // æ²¡æœ‰æ–°çš„å”¯ä¸€æ•°æ®
                            hasMoreData = false;
                            break;
                        }
                        
                        // å¦‚æœè¿”å›çš„æ•°æ®å°‘äºè¯·æ±‚çš„æ•°é‡ï¼Œè¯´æ˜æ²¡æœ‰æ›´å¤šæ•°æ®äº†
                        if (newCandles.length < 500) {
                            hasMoreData = false;
                            break;
                        }
                    } else {
                        hasMoreData = false;
                        break;
                    }
                }
                
                console.log(`å†å²æ•°æ®åŠ è½½å®Œæˆï¼Œå…±åŠ è½½ ${loadedCount} æ¡ï¼Œæ€»æ•°æ®é‡ ${allCandles.length} æ¡`);
            } catch (error) {
                console.error('æŒç»­åŠ è½½å†å²æ•°æ®å¤±è´¥:', error);
            } finally {
                isLoadingMore = false;
            }
        }
        
        // æŒç»­åŠ è½½æ›´æ–°æ•°æ®ç›´åˆ°ç¼“å†²åŒºè¶³å¤Ÿ
        async function loadMoreNewerUntilEnough(logicalRange) {
            if (isLoadingNewer || !hasNewerData) return;
            
            isLoadingNewer = true;
            let loadedCount = 0;
            const targetBuffer = 2000;
            
            try {
                while (hasNewerData && loadedCount < targetBuffer) {
                    const afterTs = newestTimestamp * 1000;
                    const url = `/api/candlesticks/?symbol=${currentSymbol}&bar=${currentBar}&limit=500&source=${currentSource}&after=${afterTs}`;
                    const response = await fetch(url);
                    const result = await response.json();
                    
                    if (result.code === 0 && result.data && result.data.length > 0) {
                        const newCandles = result.data;
                        
                        const existingTimes = new Set(allCandles.map(c => c.time));
                        const uniqueNewCandles = newCandles.filter(c => !existingTimes.has(c.time));
                        
                        if (uniqueNewCandles.length > 0) {
                            allCandles = [...allCandles, ...uniqueNewCandles];
                            allCandles.sort((a, b) => a.time - b.time);
                            newestTimestamp = allCandles[allCandles.length - 1].time;
                            loadedCount += uniqueNewCandles.length;
                            
                            updateChartData();
                        } else {
                            hasNewerData = false;
                            break;
                        }
                        
                        if (newCandles.length < 500) {
                            hasNewerData = false;
                            break;
                        }
                    } else {
                        hasNewerData = false;
                        break;
                    }
                }
                
                console.log(`æœ€æ–°æ•°æ®åŠ è½½å®Œæˆï¼Œå…±åŠ è½½ ${loadedCount} æ¡ï¼Œæ€»æ•°æ®é‡ ${allCandles.length} æ¡`);
            } catch (error) {
                console.error('æŒç»­åŠ è½½æ›´æ–°æ•°æ®å¤±è´¥:', error);
            } finally {
                isLoadingNewer = false;
            }
        }
        
        // æ›´æ–°å›¾è¡¨æ•°æ®çš„é€šç”¨å‡½æ•°
        function updateChartData() {
            const colors = getColors();
            candleSeries.setData(allCandles);
            
            // æ›´æ–°æˆäº¤é‡
            if (indicators.vol.enabled && indicators.vol.series) {
                const volumeData = allCandles.map(c => ({
                    time: c.time,
                    value: c.volume,
                    color: c.close >= c.open ? colors.upTransparent : colors.downTransparent,
                }));
                indicators.vol.series.setData(volumeData);
            }

            // æ›´æ–°å…¶ä»–æŒ‡æ ‡
            updateMainIndicators();
            updateSubIndicator();
        }

        // åˆ‡æ¢ä¸»å›¾æŒ‡æ ‡
        function toggleMainIndicator(name) {
            const checkbox = document.getElementById(`ind-${name}`);
            indicators[name].enabled = checkbox.checked;
            
            if (name === 'vol') {
                if (indicators.vol.enabled) {
                    if (indicators.vol.series) {
                        indicators.vol.series.applyOptions({ visible: true });
                        // é‡æ–°å¡«å……æ•°æ®
                        const colors = getColors();
                        const volumeData = allCandles.map(c => ({
                            time: c.time,
                            value: c.volume,
                            color: c.close >= c.open ? colors.upTransparent : colors.downTransparent,
                        }));
                        indicators.vol.series.setData(volumeData);
                    }
                } else {
                    if (indicators.vol.series) {
                        indicators.vol.series.applyOptions({ visible: false });
                    }
                }
            } else {
                if (indicators[name].enabled) {
                    removeMainIndicatorSeries(name);
                    createMainIndicatorSeries(name);
                    calculateAndSetMainIndicatorData(name);
                } else {
                    removeMainIndicatorSeries(name);
                }
            }
        }

        // åˆ‡æ¢å‰¯å›¾æŒ‡æ ‡
        function switchSubIndicator(name) {
            // æ¸…é™¤æ—§çš„å‰¯å›¾æŒ‡æ ‡
            if (indicators.subSeries.length > 0) {
                indicators.subSeries.forEach(s => chart.removeSeries(s));
                indicators.subSeries = [];
            }
            
            indicators.activeSubIndicator = name;
            
            if (name === 'none') {
                // æ¢å¤ä¸»å›¾å…¨å± (ä¿ç•™åº•éƒ¨ VOL ç©ºé—´)
                chart.priceScale('right').applyOptions({
                    scaleMargins: {
                        top: 0.1,
                        bottom: 0.2, // ç•™ç»™ VOL
                    },
                });
            } else {
                // è°ƒæ•´ä¸»å›¾ç©ºé—´ï¼Œç»™å‰¯å›¾è…¾ä½ç½®
                chart.priceScale('right').applyOptions({
                    scaleMargins: {
                        top: 0.05,
                        bottom: 0.4, // ç•™å‡º 40% ç»™å‰¯å›¾ + VOL
                    },
                });
                
                createSubIndicatorSeries(name);
                calculateAndSetSubIndicatorData(name);
            }
        }

        // åˆ›å»ºä¸»å›¾æŒ‡æ ‡ Series
        function createMainIndicatorSeries(name) {
            if (name === 'ma') {
                const ma7 = chart.addLineSeries({ color: '#E6E600', lineWidth: 1, title: 'MA7' });
                const ma25 = chart.addLineSeries({ color: '#9C27B0', lineWidth: 1, title: 'MA25' });
                const ma99 = chart.addLineSeries({ color: '#2196F3', lineWidth: 1, title: 'MA99' });
                indicators.ma.series = [ma7, ma25, ma99];
            } else if (name === 'ema') {
                const ema7 = chart.addLineSeries({ color: '#FF9800', lineWidth: 1, title: 'EMA7' });
                const ema25 = chart.addLineSeries({ color: '#00BCD4', lineWidth: 1, title: 'EMA25' });
                const ema99 = chart.addLineSeries({ color: '#E91E63', lineWidth: 1, title: 'EMA99' });
                indicators.ema.series = [ema7, ema25, ema99];
            } else if (name === 'boll') {
                const upper = chart.addLineSeries({ color: '#4CAF50', lineWidth: 1, title: 'BOLL Upper' });
                const middle = chart.addLineSeries({ color: '#F44336', lineWidth: 1, title: 'BOLL Mid' });
                const lower = chart.addLineSeries({ color: '#4CAF50', lineWidth: 1, title: 'BOLL Lower' });
                indicators.boll.series = [upper, middle, lower];
            } else if (name === 'sar') {
                const sarSeries = chart.addLineSeries({ 
                    color: '#2962FF', 
                    lineWidth: 1, 
                    lineStyle: 2, // Dashed
                    title: 'SAR' 
                });
                indicators.sar.series = [sarSeries];
            } else if (name === 'supertrend') {
                const stSeries = chart.addLineSeries({ color: '#2962FF', lineWidth: 2, title: 'SuperTrend' });
                indicators.supertrend.series = [stSeries];
            } else if (name === 'sr') {
                const support = chart.addLineSeries({ color: '#26a69a', lineWidth: 2, title: 'Support' });
                const resistance = chart.addLineSeries({ color: '#ef5350', lineWidth: 2, title: 'Resistance' });
                indicators.sr.series = [support, resistance];
            }
        }

        // åˆ›å»ºå‰¯å›¾æŒ‡æ ‡ Series
        function createSubIndicatorSeries(name) {
            const subScaleId = 'sub';
            
            // é…ç½®å‰¯å›¾ Scale
            chart.priceScale(subScaleId).applyOptions({
                scaleMargins: {
                    top: 0.65, // å‰¯å›¾ä» 65% å¼€å§‹
                    bottom: 0,
                },
            });

            if (name === 'macd') {
                const macdHist = chart.addHistogramSeries({
                    priceScaleId: subScaleId,
                    color: '#26a69a',
                    lineWidth: 1,
                    priceFormat: { type: 'volume' },
                    title: 'MACD Hist'
                });
                const dif = chart.addLineSeries({
                    priceScaleId: subScaleId,
                    color: '#2962FF',
                    lineWidth: 1,
                    title: 'DIF'
                });
                const dea = chart.addLineSeries({
                    priceScaleId: subScaleId,
                    color: '#FF6D00',
                    lineWidth: 1,
                    title: 'DEA'
                });
                indicators.subSeries = [macdHist, dif, dea];
            } else if (name === 'kdj') {
                const k = chart.addLineSeries({ priceScaleId: subScaleId, color: '#2962FF', lineWidth: 1, title: 'K' });
                const d = chart.addLineSeries({ priceScaleId: subScaleId, color: '#FF6D00', lineWidth: 1, title: 'D' });
                const j = chart.addLineSeries({ priceScaleId: subScaleId, color: '#E91E63', lineWidth: 1, title: 'J' });
                indicators.subSeries = [k, d, j];
            } else if (name === 'rsi' || name === 'psy') {
                const line = chart.addLineSeries({ priceScaleId: subScaleId, color: '#9C27B0', lineWidth: 1, title: name.toUpperCase() });
                indicators.subSeries = [line];
            } else if (name === 'stochrsi') {
                const k = chart.addLineSeries({ priceScaleId: subScaleId, color: '#2962FF', lineWidth: 1, title: 'K' });
                const d = chart.addLineSeries({ priceScaleId: subScaleId, color: '#FF6D00', lineWidth: 1, title: 'D' });
                indicators.subSeries = [k, d];
            } else if (name === 'dmi') {
                const pdi = chart.addLineSeries({ priceScaleId: subScaleId, color: '#26a69a', lineWidth: 1, title: '+DI' });
                const mdi = chart.addLineSeries({ priceScaleId: subScaleId, color: '#ef5350', lineWidth: 1, title: '-DI' });
                const adx = chart.addLineSeries({ priceScaleId: subScaleId, color: '#FF6D00', lineWidth: 1, title: 'ADX' });
                indicators.subSeries = [pdi, mdi, adx];
            } else {
                // é€šç”¨å•çº¿æŒ‡æ ‡
                const line = chart.addLineSeries({ 
                    priceScaleId: subScaleId, 
                    color: '#9C27B0', 
                    lineWidth: 1, 
                    title: name.toUpperCase() 
                });
                indicators.subSeries = [line];
                
                if (name === 'dma') {
                    const ama = chart.addLineSeries({ priceScaleId: subScaleId, color: '#FF6D00', lineWidth: 1, title: 'AMA' });
                    indicators.subSeries.push(ama);
                } else if (name === 'brar') {
                    line.applyOptions({ title: 'AR', color: '#FF6D00' });
                    const br = chart.addLineSeries({ priceScaleId: subScaleId, color: '#2962FF', lineWidth: 1, title: 'BR' });
                    indicators.subSeries.push(br);
                }
            }
        }

        // ç§»é™¤ä¸»å›¾æŒ‡æ ‡ Series
        function removeMainIndicatorSeries(name) {
            if (indicators[name].series) {
                indicators[name].series.forEach(s => chart.removeSeries(s));
                indicators[name].series = [];
            }
        }

        // æ›´æ–°æ‰€æœ‰å¼€å¯çš„ä¸»å›¾æŒ‡æ ‡
        function updateMainIndicators() {
            ['ma', 'ema', 'boll', 'sar', 'supertrend', 'sr'].forEach(name => {
                if (indicators[name].enabled) {
                    if (indicators[name].series.length === 0) {
                        createMainIndicatorSeries(name);
                    }
                    calculateAndSetMainIndicatorData(name);
                }
            });
        }
        
        // æ›´æ–°å‰¯å›¾æŒ‡æ ‡
        function updateSubIndicator() {
            if (indicators.activeSubIndicator !== 'none') {
                if (indicators.subSeries.length === 0) {
                    createSubIndicatorSeries(indicators.activeSubIndicator);
                }
                calculateAndSetSubIndicatorData(indicators.activeSubIndicator);
            }
        }

        // è®¡ç®—å¹¶è®¾ç½®ä¸»å›¾æŒ‡æ ‡æ•°æ®
        function calculateAndSetMainIndicatorData(name) {
            if (!allCandles || allCandles.length === 0) return;
            
            if (name === 'ma') {
                indicators.ma.series[0].setData(calculateSMA(allCandles, 7));
                indicators.ma.series[1].setData(calculateSMA(allCandles, 25));
                indicators.ma.series[2].setData(calculateSMA(allCandles, 99));
            } else if (name === 'ema') {
                indicators.ema.series[0].setData(calculateEMA(allCandles, 7));
                indicators.ema.series[1].setData(calculateEMA(allCandles, 25));
                indicators.ema.series[2].setData(calculateEMA(allCandles, 99));
            } else if (name === 'boll') {
                const bollData = calculateBollingerBands(allCandles, 20, 2);
                indicators.boll.series[0].setData(bollData.upper);
                indicators.boll.series[1].setData(bollData.middle);
                indicators.boll.series[2].setData(bollData.lower);
            } else if (name === 'sar') {
                indicators.sar.series[0].setData(calculateSAR(allCandles));
            } else if (name === 'supertrend') {
                indicators.supertrend.series[0].setData(calculateSuperTrend(allCandles));
            } else if (name === 'sr') {
                const srData = calculateSupportResistance(allCandles);
                indicators.sr.series[0].setData(srData.support);
                indicators.sr.series[1].setData(srData.resistance);
            }
        }
        
        // è®¡ç®—å¹¶è®¾ç½®å‰¯å›¾æŒ‡æ ‡æ•°æ®
        function calculateAndSetSubIndicatorData(name) {
            if (!allCandles || allCandles.length === 0) return;
            
            if (name === 'macd') {
                const data = calculateMACD(allCandles, 12, 26, 9);
                indicators.subSeries[0].setData(data.histogram);
                indicators.subSeries[1].setData(data.dif);
                indicators.subSeries[2].setData(data.dea);
            } else if (name === 'kdj') {
                const data = calculateKDJ(allCandles, 9, 3, 3);
                indicators.subSeries[0].setData(data.k);
                indicators.subSeries[1].setData(data.d);
                indicators.subSeries[2].setData(data.j);
            } else if (name === 'rsi') {
                indicators.subSeries[0].setData(calculateRSI(allCandles, 14));
            } else if (name === 'stochrsi') {
                const data = calculateStochRSI(allCandles, 14, 14, 3, 3);
                indicators.subSeries[0].setData(data.k);
                indicators.subSeries[1].setData(data.d);
            } else if (name === 'cci') {
                indicators.subSeries[0].setData(calculateCCI(allCandles, 20));
            } else if (name === 'dmi') {
                const data = calculateDMI(allCandles, 14);
                indicators.subSeries[0].setData(data.pdi);
                indicators.subSeries[1].setData(data.mdi);
                indicators.subSeries[2].setData(data.adx);
            } else if (name === 'wr') {
                indicators.subSeries[0].setData(calculateWR(allCandles, 14));
            } else if (name === 'obv') {
                indicators.subSeries[0].setData(calculateOBV(allCandles));
            } else if (name === 'trix') {
                indicators.subSeries[0].setData(calculateTRIX(allCandles, 12));
            } else if (name === 'roc') {
                indicators.subSeries[0].setData(calculateROC(allCandles, 12));
            } else if (name === 'mtm') {
                indicators.subSeries[0].setData(calculateMTM(allCandles, 12));
            } else if (name === 'dma') {
                const data = calculateDMA(allCandles, 10, 50);
                indicators.subSeries[0].setData(data.ddd);
                indicators.subSeries[1].setData(data.ama);
            } else if (name === 'vr') {
                indicators.subSeries[0].setData(calculateVR(allCandles, 26));
            } else if (name === 'brar') {
                const data = calculateBRAR(allCandles, 26);
                indicators.subSeries[0].setData(data.ar);
                indicators.subSeries[1].setData(data.br);
            } else if (name === 'psy') {
                indicators.subSeries[0].setData(calculatePSY(allCandles, 12));
            }
        }

        // è®¡ç®— SMA
        function calculateSMA(candles, period) {
            const result = [];
            for (let i = 0; i < candles.length; i++) {
                if (i < period - 1) continue;
                let sum = 0;
                for (let j = 0; j < period; j++) {
                    sum += candles[i - j].close;
                }
                result.push({ time: candles[i].time, value: sum / period });
            }
            return result;
        }

        // è®¡ç®— EMA
        function calculateEMA(candles, period) {
            const result = [];
            const k = 2 / (period + 1);
            let ema = candles[0].close;
            
            // åˆå§‹ EMA é€šå¸¸ç”¨ SMA ä»£æ›¿ï¼Œæˆ–è€…ç›´æ¥ä»ç¬¬ä¸€ä¸ªå€¼å¼€å§‹
            // è¿™é‡Œç®€å•å¤„ç†ï¼Œå‰ period-1 ä¸ªç‚¹ä¸è¾“å‡ºï¼Œç¬¬ period ä¸ªç‚¹ç”¨ SMA åˆå§‹åŒ–
            // æˆ–è€…æ›´ç®€å•çš„ï¼šç¬¬ä¸€ä¸ªç‚¹å°±æ˜¯ EMAï¼Œç„¶åè¿­ä»£ã€‚ä¸ºäº†å‡†ç¡®æ€§ï¼Œé€šå¸¸éœ€è¦è¶³å¤Ÿçš„å†å²æ•°æ®ã€‚
            // è¿™é‡Œé‡‡ç”¨æ ‡å‡†åšæ³•ï¼šç¬¬ä¸€ä¸ªç‚¹ä½œä¸ºåˆå§‹ EMA
            
            // é‡æ–°å®ç°ï¼šä¸ºäº†ä¸ SMA å¯¹é½ï¼Œæˆ‘ä»¬ä»ç¬¬0ä¸ªå¼€å§‹ç®—ï¼Œä½†åªè¾“å‡ºæœ‰æ•ˆéƒ¨åˆ†ï¼Ÿ
            // TradingView ç­‰é€šå¸¸ä»ä¸€å¼€å§‹å°±è®¡ç®—ã€‚
            
            ema = candles[0].close;
            result.push({ time: candles[0].time, value: ema });

            for (let i = 1; i < candles.length; i++) {
                ema = (candles[i].close - ema) * k + ema;
                result.push({ time: candles[i].time, value: ema });
            }
            return result;
        }

        // è®¡ç®— Bollinger Bands
        function calculateBollingerBands(candles, period, stdDevMultiplier) {
            const upper = [];
            const middle = [];
            const lower = [];

            for (let i = 0; i < candles.length; i++) {
                if (i < period - 1) continue;
                
                let sum = 0;
                for (let j = 0; j < period; j++) {
                    sum += candles[i - j].close;
                }
                const sma = sum / period;
                
                let sumSquaredDiff = 0;
                for (let j = 0; j < period; j++) {
                    sumSquaredDiff += Math.pow(candles[i - j].close - sma, 2);
                }
                const stdDev = Math.sqrt(sumSquaredDiff / period);

                middle.push({ time: candles[i].time, value: sma });
                upper.push({ time: candles[i].time, value: sma + stdDev * stdDevMultiplier });
                lower.push({ time: candles[i].time, value: sma - stdDev * stdDevMultiplier });
            }

        // SAR (Parabolic SAR)
        function calculateSAR(candles) {
            const result = [];
            if (candles.length < 2) return result;
            
            let af = 0.02;
            let maxAf = 0.2;
            let isLong = true;
            let sar = candles[0].low;
            let ep = candles[0].high;
            
            for (let i = 1; i < candles.length; i++) {
                const prevSar = sar;
                sar = prevSar + af * (ep - prevSar);
                
                if (isLong) {
                    if (candles[i].low < sar) {
                        isLong = false;
                        sar = ep;
                        ep = candles[i].low;
                        af = 0.02;
                    } else {
                        if (candles[i].high > ep) {
                            ep = candles[i].high;
                            af = Math.min(af + 0.02, maxAf);
                        }
                    }
                } else {
                    if (candles[i].high > sar) {
                        isLong = true;
                        sar = ep;
                        ep = candles[i].high;
                        af = 0.02;
                    } else {
                        if (candles[i].low < ep) {
                            ep = candles[i].low;
                            af = Math.min(af + 0.02, maxAf);
                        }
                    }
                }
                result.push({ time: candles[i].time, value: sar });
            }
            return result;
        }
        
        // SuperTrend
        function calculateSuperTrend(candles, period = 10, multiplier = 3) {
            const result = [];
            if (candles.length < period) return result;
            
            // è®¡ç®— ATR
            const trs = [];
            for(let i = 1; i < candles.length; i++) {
                const high = candles[i].high;
                const low = candles[i].low;
                const prevClose = candles[i-1].close;
                const tr = Math.max(high - low, Math.abs(high - prevClose), Math.abs(low - prevClose));
                trs.push(tr);
            }
            
            let atr = trs.slice(0, period).reduce((a,b) => a+b, 0) / period;
            
            let upperBand = (candles[period].high + candles[period].low) / 2 + multiplier * atr;
            let lowerBand = (candles[period].high + candles[period].low) / 2 - multiplier * atr;
            let inUptrend = true;
            
            for (let i = period; i < candles.length; i++) {
                const currHigh = candles[i].high;
                const currLow = candles[i].low;
                const currClose = candles[i].close;
                const prevClose = candles[i-1].close;
                
                if (i > period) {
                    const tr = Math.max(currHigh - currLow, Math.abs(currHigh - prevClose), Math.abs(currLow - prevClose));
                    atr = (atr * (period - 1) + tr) / period;
                }
                
                let currUpperBand = (currHigh + currLow) / 2 + multiplier * atr;
                let currLowerBand = (currHigh + currLow) / 2 - multiplier * atr;
                
                if (inUptrend) {
                    if (currLowerBand < lowerBand) currLowerBand = lowerBand;
                    if (currClose < lowerBand) {
                        inUptrend = false;
                        upperBand = currUpperBand;
                    } else {
                        lowerBand = currLowerBand;
                    }
                } else {
                    if (currUpperBand > upperBand) currUpperBand = upperBand;
                    if (currClose > upperBand) {
                        inUptrend = true;
                        lowerBand = currLowerBand;
                    } else {
                        upperBand = currUpperBand;
                    }
                }
                
                result.push({ 
                    time: candles[i].time, 
                    value: inUptrend ? lowerBand : upperBand,
                    color: inUptrend ? '#26a69a' : '#ef5350'
                });
            }
            return result;
        }
        
        // Support/Resistance (Fractals based)
        function calculateSupportResistance(candles) {
            const support = [];
            const resistance = [];
            for (let i = 2; i < candles.length - 2; i++) {
                const isHigh = candles[i].high > candles[i-1].high && 
                               candles[i].high > candles[i-2].high &&
                               candles[i].high > candles[i+1].high &&
                               candles[i].high > candles[i+2].high;
                               
                const isLow = candles[i].low < candles[i-1].low && 
                              candles[i].low < candles[i-2].low &&
                              candles[i].low < candles[i+1].low &&
                              candles[i].low < candles[i+2].low;
                              
                if (isHigh) {
                    for (let j = 0; j < 50 && i+j < candles.length; j++) {
                        resistance.push({ time: candles[i+j].time, value: candles[i].high });
                    }
                }
                if (isLow) {
                    for (let j = 0; j < 50 && i+j < candles.length; j++) {
                        support.push({ time: candles[i+j].time, value: candles[i].low });
                    }
                }
            }
            return { support, resistance };
        }

        // MACD
        function calculateMACD(candles, fastPeriod, slowPeriod, signalPeriod) {
            const emaFast = calculateEMA(candles, fastPeriod);
            const emaSlow = calculateEMA(candles, slowPeriod);
            
            const difData = [];
            const deaData = [];
            const histogramData = [];
            
            const minLen = Math.min(emaFast.length, emaSlow.length);
            const offsetFast = emaFast.length - minLen;
            const offsetSlow = emaSlow.length - minLen;
            
            const difValues = [];
            
            for (let i = 0; i < minLen; i++) {
                const val = emaFast[i + offsetFast].value - emaSlow[i + offsetSlow].value;
                const time = emaFast[i + offsetFast].time;
                difValues.push({ time, value: val });
                difData.push({ time, value: val });
            }
            
            let dea = difValues[0].value;
            const k = 2 / (signalPeriod + 1);
            
            deaData.push({ time: difValues[0].time, value: dea });
            histogramData.push({ 
                time: difValues[0].time, 
                value: difValues[0].value - dea,
                color: (difValues[0].value - dea) >= 0 ? '#26a69a' : '#ef5350'
            });
            
            for (let i = 1; i < difValues.length; i++) {
                dea = (difValues[i].value - dea) * k + dea;
                deaData.push({ time: difValues[i].time, value: dea });
                const hist = difValues[i].value - dea;
                histogramData.push({ 
                    time: difValues[i].time, 
                    value: hist,
                    color: hist >= 0 ? '#26a69a' : '#ef5350'
                });
            }
            
            return { dif: difData, dea: deaData, histogram: histogramData };
        }

        // RSI
        function calculateRSI(candles, period) {
            const result = [];
            if (candles.length < period + 1) return result;
            
            let gains = 0;
            let losses = 0;
            
            for (let i = 1; i <= period; i++) {
                const change = candles[i].close - candles[i-1].close;
                if (change > 0) gains += change;
                else losses -= change;
            }
            
            let avgGain = gains / period;
            let avgLoss = losses / period;
            
            for (let i = period + 1; i < candles.length; i++) {
                const change = candles[i].close - candles[i-1].close;
                let gain = change > 0 ? change : 0;
                let loss = change < 0 ? -change : 0;
                
                avgGain = (avgGain * (period - 1) + gain) / period;
                avgLoss = (avgLoss * (period - 1) + loss) / period;
                
                const rs = avgGain / avgLoss;
                const rsi = 100 - (100 / (1 + rs));
                
                result.push({ time: candles[i].time, value: rsi });
            }
            return result;
        }

        // KDJ
        function calculateKDJ(candles, n, m1, m2) {
            const kData = [];
            const dData = [];
            const jData = [];
            
            let k = 50;
            let d = 50;
            
            for (let i = 0; i < candles.length; i++) {
                if (i < n - 1) continue;
                
                let low = candles[i].low;
                let high = candles[i].high;
                for (let j = 0; j < n; j++) {
                    if (candles[i-j].low < low) low = candles[i-j].low;
                    if (candles[i-j].high > high) high = candles[i-j].high;
                }
                
                const rsv = (candles[i].close - low) / (high - low) * 100;
                
                k = (m1 - 1) / m1 * k + 1 / m1 * rsv;
                d = (m2 - 1) / m2 * d + 1 / m2 * k;
                const jVal = 3 * k - 2 * d;
                
                kData.push({ time: candles[i].time, value: k });
                dData.push({ time: candles[i].time, value: d });
                jData.push({ time: candles[i].time, value: jVal });
            }
            return { k: kData, d: dData, j: jData };
        }

        // CCI
        function calculateCCI(candles, period) {
            const result = [];
            if (candles.length < period) return result;
            
            const tps = candles.map(c => (c.high + c.low + c.close) / 3);
            
            for (let i = period - 1; i < candles.length; i++) {
                let sumTp = 0;
                for (let j = 0; j < period; j++) sumTp += tps[i-j];
                const maTp = sumTp / period;
                
                let sumMd = 0;
                for (let j = 0; j < period; j++) sumMd += Math.abs(tps[i-j] - maTp);
                const md = sumMd / period;
                
                const cci = (tps[i] - maTp) / (0.015 * md);
                result.push({ time: candles[i].time, value: cci });
            }
            return result;
        }

        // WR (Williams %R)
        function calculateWR(candles, period) {
            const result = [];
            for (let i = period - 1; i < candles.length; i++) {
                let highest = -Infinity;
                let lowest = Infinity;
                for (let j = 0; j < period; j++) {
                    if (candles[i-j].high > highest) highest = candles[i-j].high;
                    if (candles[i-j].low < lowest) lowest = candles[i-j].low;
                }
                const wr = (highest - candles[i].close) / (highest - lowest) * -100;
                result.push({ time: candles[i].time, value: wr });
            }
            return result;
        }

        // OBV
        function calculateOBV(candles) {
            const result = [];
            let obv = 0;
            result.push({ time: candles[0].time, value: obv });
            
            for (let i = 1; i < candles.length; i++) {
                if (candles[i].close > candles[i-1].close) {
                    obv += candles[i].volume;
                } else if (candles[i].close < candles[i-1].close) {
                    obv -= candles[i].volume;
                }
                result.push({ time: candles[i].time, value: obv });
            }
            return result;
        }

        // ROC
        function calculateROC(candles, period) {
            const result = [];
            for (let i = period; i < candles.length; i++) {
                const roc = ((candles[i].close - candles[i-period].close) / candles[i-period].close) * 100;
                result.push({ time: candles[i].time, value: roc });
            }
            return result;
        }

        // MTM
        function calculateMTM(candles, period) {
            const result = [];
            for (let i = period; i < candles.length; i++) {
                const mtm = candles[i].close - candles[i-period].close;
                result.push({ time: candles[i].time, value: mtm });
            }
            return result;
        }

        // DMI (ADX) - ç®€åŒ–ç‰ˆ
        function calculateDMI(candles, period) {
            // ç®€åŒ–ç‰ˆï¼Œè¿”å›ç©ºæ•°æ®ä»¥é¿å…é”™è¯¯
            return { pdi: [], mdi: [], adx: [] };
        }

        // StochRSI
        function calculateStochRSI(candles, rsiPeriod, stochPeriod, kPeriod, dPeriod) {
            // ç®€åŒ–ç‰ˆ
            return { k: [], d: [] };
        }

        // TRIX
        function calculateTRIX(candles, period) {
            return [];
        }

        // DMA
        function calculateDMA(candles, shortPeriod, longPeriod) {
            return { ddd: [], ama: [] };
        }

        // VR
        function calculateVR(candles, period) {
            return [];
        }

        // BRAR
        function calculateBRAR(candles, period) {
            return { br: [], ar: [] };
        }

        // PSY
        function calculatePSY(candles, period) {
            const result = [];
            for (let i = period; i < candles.length; i++) {
                let upCount = 0;
                for (let j = 0; j < period; j++) {
                    if (candles[i-j].close > candles[i-j-1].close) upCount++;
                }
                result.push({ time: candles[i].time, value: (upCount / period) * 100 });
            }
            return result;
        }

        // æ˜¾ç¤ºé”™è¯¯
        function showError(message) {
            document.getElementById('error-message').textContent = message;
            document.getElementById('error-banner').classList.add('show');
        }

        // éšè—é”™è¯¯
        function hideError() {
            document.getElementById('error-banner').classList.remove('show');
        }

        // æ˜¾ç¤ºå›¾è¡¨åŒºåŸŸé”™è¯¯
        function showChartError(message, detail) {
            const container = document.getElementById('chart-container');
            container.innerHTML = `
                <div class="chart-error">
                    <div class="error-icon">âŒ</div>
                    <div class="error-title">${message}</div>
                    <div class="error-detail">${detail}</div>
                    <button class="retry-btn" onclick="retryLoad()">ğŸ”„ é‡è¯•</button>
                </div>
            `;
        }

        // é‡è¯•åŠ è½½
        function retryLoad() {
            hideError();
            initChart();
            refreshData();
        }

        // åŠ è½½ K çº¿æ•°æ®
        async function loadCandlesticks() {
            try {
                const response = await fetch(`/api/candlesticks/?symbol=${currentSymbol}&bar=${currentBar}&limit=100&source=${currentSource}`);
                const result = await response.json();
                
                if (result.code === 0 && result.data) {
                    hideError();
                    const candles = result.data;
                    
                    // ä¿å­˜åˆ°ç¼“å­˜
                    allCandles = candles;
                    if (candles.length > 0) {
                        oldestTimestamp = candles[0].time;
                        newestTimestamp = candles[candles.length - 1].time;
                        hasMoreData = true;
                        hasNewerData = true;
                    }
                    
                    candleSeries.setData(candles);

                    const colors = getColors();
                    // æˆäº¤é‡æ•°æ®
                    const volumeData = candles.map(c => ({
                        time: c.time,
                        value: c.volume,
                        color: c.close >= c.open ? colors.upTransparent : colors.downTransparent,
                    }));
                    volumeSeries.setData(volumeData);

                    chart.timeScale().fitContent();
                } else {
                    // API è¿”å›é”™è¯¯
                    const errorMsg = result.error || 'Kçº¿æ•°æ®åŠ è½½å¤±è´¥';
                    showError(`Kçº¿æ•°æ®é”™è¯¯: ${errorMsg}`);
                    showChartError('Kçº¿æ•°æ®åŠ è½½å¤±è´¥', errorMsg);
                }
            } catch (error) {
                console.error('åŠ è½½Kçº¿å¤±è´¥:', error);
                showError(`ç½‘ç»œé”™è¯¯: ${error.message}`);
                showChartError('æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨', error.message);
            }
        }

        // åŠ è½½è¡Œæƒ…
        async function loadTicker() {
            try {
                const response = await fetch(`/api/ticker/?symbol=${currentSymbol}&source=${currentSource}`);
                const result = await response.json();
                
                if (result.code === 0 && result.data) {
                    const ticker = result.data;
                    const lastPrice = parseFloat(ticker.last);
                    const open24h = parseFloat(ticker.open24h);
                    const changePercent = ((lastPrice - open24h) / open24h * 100).toFixed(2);
                    const isUp = lastPrice >= open24h;

                    document.getElementById('last-price').textContent = lastPrice.toLocaleString();
                    document.getElementById('last-price').className = `ticker-value ${isUp ? 'up' : 'down'}`;

                    document.getElementById('change-24h').textContent = `${isUp ? '+' : ''}${changePercent}%`;
                    document.getElementById('change-24h').className = `ticker-value ${isUp ? 'up' : 'down'}`;

                    document.getElementById('high-24h').textContent = parseFloat(ticker.high24h).toLocaleString();
                    document.getElementById('low-24h').textContent = parseFloat(ticker.low24h).toLocaleString();
                    document.getElementById('volume-24h').textContent = parseFloat(ticker.vol24h).toLocaleString();
                } else {
                    // API è¿”å›é”™è¯¯
                    const errorMsg = result.error || 'è¡Œæƒ…æ•°æ®åŠ è½½å¤±è´¥';
                    showError(`è¡Œæƒ…é”™è¯¯: ${errorMsg}`);
                    // æ¸…ç©ºè¡Œæƒ…æ˜¾ç¤º
                    document.getElementById('last-price').textContent = '--';
                    document.getElementById('change-24h').textContent = '--';
                    document.getElementById('high-24h').textContent = '--';
                    document.getElementById('low-24h').textContent = '--';
                    document.getElementById('volume-24h').textContent = '--';
                }
            } catch (error) {
                console.error('åŠ è½½è¡Œæƒ…å¤±è´¥:', error);
                showError(`è¡Œæƒ…ç½‘ç»œé”™è¯¯: ${error.message}`);
            }
        }

        // åˆ·æ–°æ•°æ®
        function refreshData() {
            loadCandlesticks();
            loadTicker();
        }

        // äº‹ä»¶ç»‘å®š
        document.getElementById('symbol-select').addEventListener('change', (e) => {
            currentSymbol = e.target.value;
            refreshData();
        });

        document.getElementById('source-select').addEventListener('change', (e) => {
            currentSource = e.target.value;
            refreshData();
        });

        document.querySelectorAll('.timeframe-buttons button').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.timeframe-buttons button').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentBar = btn.dataset.bar;
                document.getElementById('more-timeframes').value = '';
                document.getElementById('custom-interval').style.display = 'none';
                refreshData();
            });
        });
        
        // æ›´å¤šå‘¨æœŸä¸‹æ‹‰èœå•
        document.getElementById('more-timeframes').addEventListener('change', (e) => {
            const value = e.target.value;
            if (!value) return;
            
            if (value === 'custom') {
                // æ˜¾ç¤ºè‡ªå®šä¹‰è¾“å…¥æ¡†
                document.getElementById('custom-interval').style.display = 'block';
                document.getElementById('custom-interval').focus();
            } else {
                // é€‰æ‹©é¢„è®¾å‘¨æœŸ
                document.querySelectorAll('.timeframe-buttons button').forEach(b => b.classList.remove('active'));
                currentBar = value;
                document.getElementById('custom-interval').style.display = 'none';
                refreshData();
            }
        });
        
        // è‡ªå®šä¹‰å‘¨æœŸè¾“å…¥
        document.getElementById('custom-interval').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const customValue = e.target.value.trim().toUpperCase();
                if (customValue) {
                    // éªŒè¯æ ¼å¼ï¼šæ•°å­— + å•ä½ (å¦‚: 2H, 7D, 90m)
                    const match = customValue.match(/^(\d+)([SMHDW])$/);
                    if (match) {
                        document.querySelectorAll('.timeframe-buttons button').forEach(b => b.classList.remove('active'));
                        currentBar = customValue.toLowerCase();
                        refreshData();
                    } else {
                        alert('æ ¼å¼é”™è¯¯ï¼è¯·ä½¿ç”¨æ ¼å¼ï¼šæ•°å­—+å•ä½\\nä¾‹å¦‚ï¼š2H (2å°æ—¶), 7D (7å¤©), 90m (90åˆ†é’Ÿ)\\nå•ä½ï¼šs(ç§’) m(åˆ†) H(æ—¶) D(æ—¥) W(å‘¨)');
                    }
                }
            }
        });

        document.getElementById('refresh-btn').addEventListener('click', refreshData);

        // è®¾ç½®åˆå§‹é€‰ä¸­çŠ¶æ€
        document.getElementById('symbol-select').value = currentSymbol;
        document.getElementById('source-select').value = currentSource;
        document.querySelectorAll('.timeframe-buttons button').forEach(btn => {
            if (btn.dataset.bar === currentBar) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });

        // åˆå§‹åŒ–
        initChart();
        refreshData();

        // å®šæ—¶åˆ·æ–°ï¼ˆæ¯30ç§’ï¼‰
        setInterval(refreshData, 30000);
    </script>
</body>
</html>
