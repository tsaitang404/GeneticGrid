<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeneticGrid - Kçº¿çœ‹ç›˜</title>
    <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        :root {
            --up-color: #26a69a;
            --down-color: #ef5350;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #131722;
            color: #d1d4dc;
            min-height: 100vh;
        }
        .header {
            background: #1e222d;
            padding: 16px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #2a2e39;
        }
        .header h1 {
            font-size: 20px;
            color: #fff;
        }
        .controls {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        .controls select, .controls button {
            background: #2a2e39;
            color: #d1d4dc;
            border: 1px solid #363a45;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
        }
        .controls select:hover, .controls button:hover {
            background: #363a45;
        }
        .ticker-info {
            display: flex;
            gap: 24px;
            padding: 12px 24px;
            background: #1e222d;
            border-bottom: 1px solid #2a2e39;
        }
        .ticker-item {
            display: flex;
            flex-direction: column;
        }
        .ticker-label {
            font-size: 12px;
            color: #787b86;
        }
        .ticker-value {
            font-size: 16px;
            font-weight: 600;
        }
        .ticker-value.up { color: var(--up-color); }
        .ticker-value.down { color: var(--down-color); }
        #chart-container {
            width: 100%;
            height: calc(100vh - 140px);
            position: relative;
        }
        /* æ‚¬åœä¿¡æ¯é¢æ¿ */
        .candle-tooltip {
            position: absolute;
            top: 12px;
            left: 12px;
            background: rgba(30, 34, 45, 0.95);
            border: 1px solid #363a45;
            border-radius: 4px;
            padding: 10px 14px;
            font-size: 13px;
            z-index: 100;
            pointer-events: none;
            min-width: 180px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .candle-tooltip.locked {
            border: 2px solid #2962ff;
            box-shadow: 0 0 10px rgba(41, 98, 255, 0.3);
        }
        .candle-tooltip.locked::before {
            content: 'ğŸ”’';
            position: absolute;
            top: 8px;
            right: 10px;
            font-size: 12px;
        }
        .candle-tooltip .tooltip-time {
            color: #787b86;
            margin-bottom: 8px;
            font-size: 12px;
        }
        .candle-tooltip .tooltip-row {
            display: flex;
            justify-content: space-between;
            margin: 4px 0;
        }
        .candle-tooltip .tooltip-label {
            color: #787b86;
        }
        .candle-tooltip .tooltip-value {
            font-weight: 500;
            margin-left: 16px;
        }
        .candle-tooltip .tooltip-value.up { color: var(--up-color); }
        .candle-tooltip .tooltip-value.down { color: var(--down-color); }
        .timeframe-buttons {
            display: flex;
            gap: 4px;
            align-items: center;
        }
        .timeframe-buttons button {
            padding: 6px 12px;
            min-width: 40px;
        }
        .timeframe-buttons button.active {
            background: #2962ff;
            border-color: #2962ff;
            color: #fff;
        }
        .timeframe-select {
            background: #2a2e39;
            color: #d1d4dc;
            border: 1px solid #363a45;
            padding: 6px 8px;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            margin-left: 8px;
        }
        .timeframe-select:hover {
            background: #363a45;
        }
        .custom-interval-input {
            background: #2a2e39;
            color: #d1d4dc;
            border: 1px solid #363a45;
            padding: 6px 8px;
            border-radius: 4px;
            font-size: 13px;
            width: 80px;
            margin-left: 8px;
            display: none;
        }
        .custom-interval-input:focus {
            outline: none;
            border-color: #2962ff;
        }
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            font-size: 18px;
            color: #787b86;
        }
        .error-banner {
            background: #ef5350;
            color: #fff;
            padding: 12px 24px;
            display: none;
            align-items: center;
            gap: 12px;
        }
        .error-banner.show {
            display: flex;
        }
        .error-banner .error-icon {
            font-size: 20px;
        }
        .error-banner .error-message {
            flex: 1;
        }
        .error-banner .error-close {
            background: none;
            border: none;
            color: #fff;
            font-size: 18px;
            cursor: pointer;
            padding: 4px 8px;
        }
        .chart-error {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            color: #ef5350;
            text-align: center;
            padding: 40px;
        }
        .chart-error .error-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }
        .chart-error .error-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        .chart-error .error-detail {
            font-size: 14px;
            color: #787b86;
            max-width: 500px;
            word-break: break-all;
        }
        .chart-error .retry-btn {
            margin-top: 20px;
            background: #2962ff;
            color: #fff;
            border: none;
            padding: 10px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .chart-error .retry-btn:hover {
            background: #1e4bd8;
        }
        .source-select {
            background: #2a2e39;
            color: #d1d4dc;
            border: 1px solid #363a45;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
        }
        .source-select:hover {
            background: #363a45;
        }
        .source-label {
            font-size: 12px;
            color: #787b86;
            margin-right: 4px;
        }
        
        /* è®¾ç½®æ¨¡æ€æ¡† */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-overlay.show {
            display: flex;
        }
        .modal {
            background: #1e222d;
            border: 1px solid #363a45;
            border-radius: 6px;
            width: 400px;
            max-width: 90%;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        }
        .modal-header {
            padding: 16px 20px;
            border-bottom: 1px solid #2a2e39;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-title {
            font-size: 16px;
            font-weight: 600;
            color: #d1d4dc;
        }
        .modal-close {
            background: none;
            border: none;
            color: #787b86;
            font-size: 20px;
            cursor: pointer;
            padding: 0;
        }
        .modal-close:hover {
            color: #d1d4dc;
        }
        .modal-body {
            padding: 20px;
        }
        .setting-item {
            margin-bottom: 20px;
        }
        .setting-label {
            display: block;
            margin-bottom: 8px;
            color: #d1d4dc;
            font-size: 14px;
        }
        .setting-options {
            display: flex;
            gap: 10px;
        }
        .radio-label {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            color: #787b86;
            font-size: 14px;
        }
        .radio-label input {
            margin: 0;
        }
        .radio-label:hover {
            color: #d1d4dc;
        }
        .color-preview {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 2px;
            margin-right: 4px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ§¬ GeneticGrid çœ‹ç›˜</h1>
        <div class="controls">
            <select id="symbol-select">
                <option value="BTC-USDT">BTC/USDT</option>
                <option value="ETH-USDT">ETH/USDT</option>
                <option value="SOL-USDT">SOL/USDT</option>
                <option value="XRP-USDT">XRP/USDT</option>
                <option value="DOGE-USDT">DOGE/USDT</option>
                <option value="ADA-USDT">ADA/USDT</option>
                <option value="AVAX-USDT">AVAX/USDT</option>
                <option value="LINK-USDT">LINK/USDT</option>
            </select>
            <div class="timeframe-buttons">
                <button data-bar="1m">1åˆ†</button>
                <button data-bar="5m">5åˆ†</button>
                <button data-bar="15m">15åˆ†</button>
                <button data-bar="1H" class="active">1æ—¶</button>
                <button data-bar="4H">4æ—¶</button>
                <button data-bar="1D">æ—¥çº¿</button>
                <select id="more-timeframes" class="timeframe-select">
                    <option value="">æ›´å¤šå‘¨æœŸ...</option>
                    <option value="tick">åˆ†æ—¶</option>
                    <option value="1s">1ç§’</option>
                    <option value="5s">5ç§’</option>
                    <option value="15s">15ç§’</option>
                    <option value="30s">30ç§’</option>
                    <option value="1m">1åˆ†</option>
                    <option value="3m">3åˆ†</option>
                    <option value="5m">5åˆ†</option>
                    <option value="15m">15åˆ†</option>
                    <option value="30m">30åˆ†</option>
                    <option value="1H">1æ—¶</option>
                    <option value="3H">3æ—¶</option>
                    <option value="6H">6æ—¶</option>
                    <option value="12H">12æ—¶</option>
                    <option value="1D">1æ—¥</option>
                    <option value="3D">3æ—¥</option>
                    <option value="5D">5æ—¥</option>
                    <option value="1W">1å‘¨</option>
                    <option value="1M">1æœˆ</option>
                    <option value="3M">3æœˆ</option>
                    <option value="custom">è‡ªå®šä¹‰...</option>
                </select>
                <input type="text" id="custom-interval" class="custom-interval-input" placeholder="å¦‚: 2H, 7D">
            </div>
            <span class="source-label">æ•°æ®æº:</span>
            <select id="source-select" class="source-select">
                <option value="binance">Binance</option>
                <option value="coingecko">CoinGecko</option>
                <option value="okx">OKX</option>
            </select>
            <button id="refresh-btn">ğŸ”„ åˆ·æ–°</button>
            <button id="settings-btn" title="è®¾ç½®">âš™ï¸</button>
        </div>
    </div>

    <div class="error-banner" id="error-banner">
        <span class="error-icon">âš ï¸</span>
        <span class="error-message" id="error-message"></span>
        <button class="error-close" onclick="hideError()">âœ•</button>
    </div>

    <div class="ticker-info">
        <div class="ticker-item">
            <span class="ticker-label">æœ€æ–°ä»·</span>
            <span class="ticker-value" id="last-price">--</span>
        </div>
        <div class="ticker-item">
            <span class="ticker-label">24hæ¶¨è·Œ</span>
            <span class="ticker-value" id="change-24h">--</span>
        </div>
        <div class="ticker-item">
            <span class="ticker-label">24hæœ€é«˜</span>
            <span class="ticker-value" id="high-24h">--</span>
        </div>
        <div class="ticker-item">
            <span class="ticker-label">24hæœ€ä½</span>
            <span class="ticker-value" id="low-24h">--</span>
        </div>
        <div class="ticker-item">
            <span class="ticker-label">24hæˆäº¤é‡</span>
            <span class="ticker-value" id="volume-24h">--</span>
        </div>
    </div>

    <div id="chart-container">
        <div class="loading">åŠ è½½ä¸­...</div>
        <div class="candle-tooltip" id="candle-tooltip" style="display: none;">
            <div class="tooltip-time" id="tooltip-time"></div>
            <div class="tooltip-row">
                <span class="tooltip-label">å¼€ç›˜</span>
                <span class="tooltip-value" id="tooltip-open">--</span>
            </div>
            <div class="tooltip-row">
                <span class="tooltip-label">æœ€é«˜</span>
                <span class="tooltip-value" id="tooltip-high">--</span>
            </div>
            <div class="tooltip-row">
                <span class="tooltip-label">æœ€ä½</span>
                <span class="tooltip-value" id="tooltip-low">--</span>
            </div>
            <div class="tooltip-row">
                <span class="tooltip-label">æ”¶ç›˜</span>
                <span class="tooltip-value" id="tooltip-close">--</span>
            </div>
            <div class="tooltip-row">
                <span class="tooltip-label">æ¶¨è·Œ</span>
                <span class="tooltip-value" id="tooltip-change">--</span>
            </div>
            <div class="tooltip-row">
                <span class="tooltip-label">æˆäº¤é‡</span>
                <span class="tooltip-value" id="tooltip-volume">--</span>
            </div>
        </div>
    </div>

    <!-- è®¾ç½®æ¨¡æ€æ¡† -->
    <div class="modal-overlay" id="settings-modal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">åå¥½è®¾ç½®</div>
                <button class="modal-close" onclick="toggleSettings()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="setting-item">
                    <span class="setting-label">æ¶¨è·Œé¢œè‰²</span>
                    <div class="setting-options">
                        <label class="radio-label">
                            <input type="radio" name="color-scheme" value="green-up" checked onchange="changeColorScheme('green-up')">
                            <span><span class="color-preview" style="background:#26a69a"></span>ç»¿æ¶¨<span class="color-preview" style="background:#ef5350; margin-left:4px"></span>çº¢è·Œ</span>
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="color-scheme" value="red-up" onchange="changeColorScheme('red-up')">
                            <span><span class="color-preview" style="background:#ef5350"></span>çº¢æ¶¨<span class="color-preview" style="background:#26a69a; margin-left:4px"></span>ç»¿è·Œ</span>
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let chart = null;
        let candleSeries = null;
        let volumeSeries = null;
        let highlightSeries = null;
        let currentSymbol = '{{ inst_id }}';
        let currentBar = '{{ bar }}';
        let currentSource = '{{ source }}';
        
        // é¢œè‰²é…ç½®
        const COLORS = {
            GREEN: '#26a69a',
            RED: '#ef5350',
            GREEN_TRANSPARENT: '#26a69a80',
            RED_TRANSPARENT: '#ef535080'
        };
        
        // åå¥½è®¾ç½®
        let settings = {
            colorScheme: localStorage.getItem('geneticgrid_color_scheme') || 'green-up' // 'green-up' or 'red-up'
        };

        // è·å–å½“å‰é¢œè‰²é…ç½®
        function getColors() {
            if (settings.colorScheme === 'green-up') {
                return {
                    up: COLORS.GREEN,
                    down: COLORS.RED,
                    upTransparent: COLORS.GREEN_TRANSPARENT,
                    downTransparent: COLORS.RED_TRANSPARENT
                };
            } else {
                return {
                    up: COLORS.RED,
                    down: COLORS.GREEN,
                    upTransparent: COLORS.RED_TRANSPARENT,
                    downTransparent: COLORS.GREEN_TRANSPARENT
                };
            }
        }

        // åº”ç”¨é¢œè‰²è®¾ç½®
        function applyColorScheme() {
            const colors = getColors();
            const root = document.documentElement;
            
            // æ›´æ–° CSS å˜é‡
            root.style.setProperty('--up-color', colors.up);
            root.style.setProperty('--down-color', colors.down);
            
            // æ›´æ–°å•é€‰æ¡†çŠ¶æ€
            const radios = document.getElementsByName('color-scheme');
            for (let radio of radios) {
                if (radio.value === settings.colorScheme) {
                    radio.checked = true;
                }
            }

            // å¦‚æœå›¾è¡¨å·²åˆå§‹åŒ–ï¼Œæ›´æ–°å›¾è¡¨é…ç½®
            if (candleSeries) {
                candleSeries.applyOptions({
                    upColor: colors.up,
                    downColor: colors.down,
                    borderDownColor: colors.down,
                    borderUpColor: colors.up,
                    wickDownColor: colors.down,
                    wickUpColor: colors.up,
                });
                
                // é‡æ–°æ¸²æŸ“æ•°æ®ä»¥æ›´æ–°æˆäº¤é‡é¢œè‰²
                if (allCandles.length > 0) {
                    updateChartData();
                }
            }
        }

        // åˆ‡æ¢è®¾ç½®æ¨¡æ€æ¡†
        function toggleSettings() {
            const modal = document.getElementById('settings-modal');
            if (modal.classList.contains('show')) {
                modal.classList.remove('show');
            } else {
                modal.classList.add('show');
            }
        }

        // æ›´æ”¹é¢œè‰²æ–¹æ¡ˆ
        function changeColorScheme(scheme) {
            settings.colorScheme = scheme;
            localStorage.setItem('geneticgrid_color_scheme', scheme);
            applyColorScheme();
        }

        // åˆå§‹åŒ–æ—¶åº”ç”¨è®¾ç½®
        document.addEventListener('DOMContentLoaded', () => {
            applyColorScheme();
            
            // ç»‘å®šè®¾ç½®æŒ‰é’®äº‹ä»¶
            document.getElementById('settings-btn').addEventListener('click', toggleSettings);
            
            // ç‚¹å‡»é®ç½©å±‚å…³é—­
            document.getElementById('settings-modal').addEventListener('click', (e) => {
                if (e.target.id === 'settings-modal') {
                    toggleSettings();
                }
            });
        });

        // æ•°æ®ç¼“å­˜
        let allCandles = [];
        let isLoadingMore = false;
        let isLoadingNewer = false;
        let oldestTimestamp = null;
        let newestTimestamp = null;
        let hasMoreData = true;
        let hasNewerData = true;
        
        // Tooltip é”å®šçŠ¶æ€
        let isTooltipLocked = false;
        let lockedCandleTime = null;

        // åˆå§‹åŒ–å›¾è¡¨
        function initChart() {
            const container = document.getElementById('chart-container');
            
            // åªç§»é™¤å›¾è¡¨ï¼Œä¿ç•™ tooltip
            const existingTooltip = document.getElementById('candle-tooltip');
            container.innerHTML = '';
            
            // é‡æ–°æ·»åŠ  tooltip
            if (!existingTooltip) {
                const tooltip = document.createElement('div');
                tooltip.className = 'candle-tooltip';
                tooltip.id = 'candle-tooltip';
                tooltip.style.display = 'none';
                tooltip.innerHTML = `
                    <div class="tooltip-time" id="tooltip-time"></div>
                    <div class="tooltip-row">
                        <span class="tooltip-label">å¼€ç›˜</span>
                        <span class="tooltip-value" id="tooltip-open">--</span>
                    </div>
                    <div class="tooltip-row">
                        <span class="tooltip-label">æœ€é«˜</span>
                        <span class="tooltip-value" id="tooltip-high">--</span>
                    </div>
                    <div class="tooltip-row">
                        <span class="tooltip-label">æœ€ä½</span>
                        <span class="tooltip-value" id="tooltip-low">--</span>
                    </div>
                    <div class="tooltip-row">
                        <span class="tooltip-label">æ”¶ç›˜</span>
                        <span class="tooltip-value" id="tooltip-close">--</span>
                    </div>
                    <div class="tooltip-row">
                        <span class="tooltip-label">æ¶¨è·Œ</span>
                        <span class="tooltip-value" id="tooltip-change">--</span>
                    </div>
                    <div class="tooltip-row">
                        <span class="tooltip-label">æˆäº¤é‡</span>
                        <span class="tooltip-value" id="tooltip-volume">--</span>
                    </div>
                `;
                container.appendChild(tooltip);
            } else {
                container.appendChild(existingTooltip);
            }
            
            // é‡ç½®æ•°æ®çŠ¶æ€
            allCandles = [];
            oldestTimestamp = null;
            newestTimestamp = null;
            hasMoreData = true;
            hasNewerData = true;
            isLoadingMore = false;
            isLoadingNewer = false;

            chart = LightweightCharts.createChart(container, {
                layout: {
                    background: { type: 'solid', color: '#131722' },
                    textColor: '#d1d4dc',
                },
                grid: {
                    vertLines: { color: '#1e222d' },
                    horzLines: { color: '#1e222d' },
                },
                crosshair: {
                    mode: LightweightCharts.CrosshairMode.Normal,
                },
                rightPriceScale: {
                    borderColor: '#2a2e39',
                },
                timeScale: {
                    borderColor: '#2a2e39',
                    timeVisible: true,
                    secondsVisible: false,
                },
            });

            const colors = getColors();

            // Kçº¿åºåˆ—
            candleSeries = chart.addCandlestickSeries({
                upColor: colors.up,
                downColor: colors.down,
                borderDownColor: colors.down,
                borderUpColor: colors.up,
                wickDownColor: colors.down,
                wickUpColor: colors.up,
            });

            // æˆäº¤é‡åºåˆ—
            volumeSeries = chart.addHistogramSeries({
                color: colors.up,
                priceFormat: {
                    type: 'volume',
                },
                priceScaleId: '',
            });
            volumeSeries.priceScale().applyOptions({
                scaleMargins: {
                    top: 0.8,
                    bottom: 0,
                },
            });
            
            // åˆ›å»ºç”¨äºæ ‡è®°é€‰ä¸­èœ¡çƒ›çš„ç³»åˆ—
            markerSeries = chart.addLineSeries({
                color: 'transparent',
                lineWidth: 0,
                priceLineVisible: false,
                lastValueVisible: false,
                crosshairMarkerVisible: false,
            });
            
            // åˆ›å»ºç”¨äºé«˜äº®é€‰ä¸­èœ¡çƒ›çš„ç³»åˆ—ï¼ˆç™½è‰²è¾¹æ¡†ï¼‰
            highlightSeries = chart.addCandlestickSeries({
                upColor: 'transparent',
                downColor: 'transparent',
                borderUpColor: '#ffffff',
                borderDownColor: '#ffffff',
                wickUpColor: '#ffffff',
                wickDownColor: '#ffffff',
                borderVisible: true,
                priceLineVisible: false,
                lastValueVisible: false,
            });

            // è‡ªé€‚åº”å¤§å°
            new ResizeObserver(entries => {
                if (entries.length === 0 || entries[0].target !== container) return;
                const { width, height } = entries[0].contentRect;
                chart.applyOptions({ width, height });
            }).observe(container);
            
            // ç›‘å¬å¯è§èŒƒå›´å˜åŒ–ï¼ŒåŠ è½½æ›´å¤šå†å²æ•°æ®
            chart.timeScale().subscribeVisibleLogicalRangeChange(onVisibleRangeChange);
            
            // ç›‘å¬åå­—çº¿ç§»åŠ¨ï¼Œæ˜¾ç¤ºæ‚¬åœä¿¡æ¯
            chart.subscribeCrosshairMove(onCrosshairMove);
            
            // ç›‘å¬ç‚¹å‡»äº‹ä»¶ï¼Œé”å®š/è§£é”tooltip
            chart.subscribeClick(onChartClick);
        }
        
        // ç‚¹å‡»å›¾è¡¨æ—¶é”å®š/è§£é”tooltip
        function onChartClick(param) {
            if (!param || !param.time) {
                // ç‚¹å‡»ç©ºç™½åŒºåŸŸï¼Œè§£é”tooltip
                isTooltipLocked = false;
                lockedCandleTime = null;
                const tooltip = document.getElementById('candle-tooltip');
                if (tooltip) {
                    tooltip.classList.remove('locked');
                }
                // æ¸…é™¤é«˜äº®
                if (highlightSeries) {
                    highlightSeries.setData([]);
                }
                return;
            }
            
            const candleData = param.seriesData.get(candleSeries);
            if (!candleData) {
                return;
            }
            
            // å¦‚æœç‚¹å‡»çš„æ˜¯å·²é”å®šçš„èœ¡çƒ›ï¼Œè§£é”
            if (isTooltipLocked && lockedCandleTime === param.time) {
                isTooltipLocked = false;
                lockedCandleTime = null;
                const tooltip = document.getElementById('candle-tooltip');
                if (tooltip) {
                    tooltip.classList.remove('locked');
                }
                // æ¸…é™¤é«˜äº®
                if (highlightSeries) {
                    highlightSeries.setData([]);
                }
            } else {
                // é”å®šåˆ°æ–°çš„èœ¡çƒ›
                isTooltipLocked = true;
                lockedCandleTime = param.time;
                const tooltip = document.getElementById('candle-tooltip');
                if (tooltip) {
                    tooltip.classList.add('locked');
                }
                // æ·»åŠ ç™½è‰²è¾¹æ¡†é«˜äº®
                if (highlightSeries) {
                    highlightSeries.setData([{
                        time: param.time,
                        open: candleData.open,
                        high: candleData.high,
                        low: candleData.low,
                        close: candleData.close
                    }]);
                }
                // æ›´æ–°tooltipå†…å®¹
                updateTooltipContent(param);
            }
        }
        
        // åå­—çº¿ç§»åŠ¨æ—¶æ˜¾ç¤º K çº¿ä¿¡æ¯
        function onCrosshairMove(param) {
            // å¦‚æœtooltipå·²é”å®šï¼Œä¸å“åº”æ‚¬åœ
            if (isTooltipLocked) {
                return;
            }
            
            const tooltip = document.getElementById('candle-tooltip');
            
            // æ£€æŸ¥ tooltip å…ƒç´ æ˜¯å¦å­˜åœ¨
            if (!tooltip) {
                return;
            }
            
            if (!param || !param.time || param.point === undefined || 
                param.point.x < 0 || param.point.y < 0) {
                tooltip.style.display = 'none';
                return;
            }
            
            updateTooltipContent(param);
        }
        
        // æ›´æ–°tooltipå†…å®¹çš„é€šç”¨å‡½æ•°
        function updateTooltipContent(param) {
            const tooltip = document.getElementById('candle-tooltip');
            if (!tooltip) return;
            
            const candleData = param.seriesData.get(candleSeries);
            const volumeData = param.seriesData.get(volumeSeries);
            
            if (!candleData) {
                if (!isTooltipLocked) {
                    tooltip.style.display = 'none';
                }
                return;
            }
            
            // æ ¼å¼åŒ–æ—¶é—´
            const date = new Date(param.time * 1000);
            const timeStr = date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            // è®¡ç®—æ¶¨è·Œå¹…
            const change = candleData.close - candleData.open;
            const changePercent = ((change / candleData.open) * 100).toFixed(2);
            const isUp = change >= 0;
            const colorClass = isUp ? 'up' : 'down';
            
            // æ ¼å¼åŒ–æ•°å­—
            const formatNum = (num) => {
                if (num >= 1000) return num.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                if (num >= 1) return num.toFixed(4);
                return num.toPrecision(4);
            };
            
            const formatVolume = (vol) => {
                if (vol >= 1e9) return (vol / 1e9).toFixed(2) + 'B';
                if (vol >= 1e6) return (vol / 1e6).toFixed(2) + 'M';
                if (vol >= 1e3) return (vol / 1e3).toFixed(2) + 'K';
                return vol.toFixed(2);
            };
            
            // è·å–æ‰€æœ‰ tooltip å­å…ƒç´ å¹¶æ£€æŸ¥æ˜¯å¦å­˜åœ¨
            const timeEl = document.getElementById('tooltip-time');
            const openEl = document.getElementById('tooltip-open');
            const highEl = document.getElementById('tooltip-high');
            const lowEl = document.getElementById('tooltip-low');
            const closeEl = document.getElementById('tooltip-close');
            const changeEl = document.getElementById('tooltip-change');
            const volumeEl = document.getElementById('tooltip-volume');
            
            // å¦‚æœä»»ä½•å…ƒç´ ä¸å­˜åœ¨ï¼Œç›´æ¥è¿”å›
            if (!timeEl || !openEl || !highEl || !lowEl || !closeEl || !changeEl || !volumeEl) {
                return;
            }
            
            // æ›´æ–° tooltip å†…å®¹
            timeEl.textContent = timeStr;
            openEl.textContent = formatNum(candleData.open);
            highEl.textContent = formatNum(candleData.high);
            lowEl.textContent = formatNum(candleData.low);
            
            closeEl.textContent = formatNum(candleData.close);
            closeEl.className = `tooltip-value ${colorClass}`;
            
            changeEl.textContent = `${isUp ? '+' : ''}${changePercent}%`;
            changeEl.className = `tooltip-value ${colorClass}`;
            
            const volume = volumeData ? volumeData.value : (candleData.volume || 0);
            volumeEl.textContent = formatVolume(volume);
            
            tooltip.style.display = 'block';
        }
        
        // å¯è§èŒƒå›´å˜åŒ–æ—¶æ£€æŸ¥æ˜¯å¦éœ€è¦åŠ è½½æ›´å¤šæ•°æ®
        function onVisibleRangeChange(logicalRange) {
            if (!logicalRange) return;
            
            const dataLength = allCandles.length;
            if (dataLength === 0) return;
            
            // æ£€æŸ¥å·¦ä¾§ï¼ˆå†å²æ•°æ®ï¼‰- æ›´æ¿€è¿›çš„ç­–ç•¥ï¼Œç¡®ä¿å§‹ç»ˆæœ‰è¶³å¤Ÿæ•°æ®
            // å½“å¯è§èŒƒå›´çš„èµ·å§‹ä½ç½®æ¥è¿‘å·²åŠ è½½æ•°æ®çš„è¾¹ç•Œæ—¶ï¼Œç«‹å³åŠ è½½æ›´å¤š
            if (logicalRange.from < 500 && hasMoreData && !isLoadingMore) {
                // ç«‹å³è§¦å‘åŠ è½½
                loadMoreHistoryUntilEnough(logicalRange);
            }
            
            // æ£€æŸ¥å³ä¾§ï¼ˆæ›´æ–°æ•°æ®ï¼‰
            if (logicalRange.to > dataLength - 500 && hasNewerData && !isLoadingNewer) {
                loadMoreNewerUntilEnough(logicalRange);
            }
        }
        
        // æŒç»­åŠ è½½å†å²æ•°æ®ç›´åˆ°ç¼“å†²åŒºè¶³å¤Ÿ
        async function loadMoreHistoryUntilEnough(logicalRange) {
            if (isLoadingMore || !hasMoreData) return;
            
            isLoadingMore = true;
            let loadedCount = 0;
            const targetBuffer = 2000; // è¿›ä¸€æ­¥å¢åŠ ç›®æ ‡ç¼“å†²åŒºåˆ°2000æ¡ï¼ˆçº¦33å°æ—¶çš„1åˆ†é’Ÿæ•°æ®ï¼‰
            
            try {
                // æŒç»­åŠ è½½ç›´åˆ°ç¼“å†²åŒºè¶³å¤Ÿæˆ–æ²¡æœ‰æ›´å¤šæ•°æ®
                while (hasMoreData && loadedCount < targetBuffer) {
                    const beforeTs = oldestTimestamp * 1000;
                    const url = `/api/candlesticks/?symbol=${currentSymbol}&bar=${currentBar}&limit=500&source=${currentSource}&before=${beforeTs}`;
                    const response = await fetch(url);
                    const result = await response.json();
                    
                    if (result.code === 0 && result.data && result.data.length > 0) {
                        const newCandles = result.data;
                        
                        // è¿‡æ»¤æ‰å·²å­˜åœ¨çš„æ•°æ®
                        const existingTimes = new Set(allCandles.map(c => c.time));
                        const uniqueNewCandles = newCandles.filter(c => !existingTimes.has(c.time));
                        
                        if (uniqueNewCandles.length > 0) {
                            allCandles = [...uniqueNewCandles, ...allCandles];
                            allCandles.sort((a, b) => a.time - b.time);
                            oldestTimestamp = allCandles[0].time;
                            loadedCount += uniqueNewCandles.length;
                            
                            // æ¯æ¬¡åŠ è½½åæ›´æ–°å›¾è¡¨
                            updateChartData();
                        } else {
                            // æ²¡æœ‰æ–°çš„å”¯ä¸€æ•°æ®
                            hasMoreData = false;
                            break;
                        }
                        
                        // å¦‚æœè¿”å›çš„æ•°æ®å°‘äºè¯·æ±‚çš„æ•°é‡ï¼Œè¯´æ˜æ²¡æœ‰æ›´å¤šæ•°æ®äº†
                        if (newCandles.length < 500) {
                            hasMoreData = false;
                            break;
                        }
                    } else {
                        hasMoreData = false;
                        break;
                    }
                }
                
                console.log(`å†å²æ•°æ®åŠ è½½å®Œæˆï¼Œå…±åŠ è½½ ${loadedCount} æ¡ï¼Œæ€»æ•°æ®é‡ ${allCandles.length} æ¡`);
            } catch (error) {
                console.error('æŒç»­åŠ è½½å†å²æ•°æ®å¤±è´¥:', error);
            } finally {
                isLoadingMore = false;
            }
        }
        
        // æŒç»­åŠ è½½æ›´æ–°æ•°æ®ç›´åˆ°ç¼“å†²åŒºè¶³å¤Ÿ
        async function loadMoreNewerUntilEnough(logicalRange) {
            if (isLoadingNewer || !hasNewerData) return;
            
            isLoadingNewer = true;
            let loadedCount = 0;
            const targetBuffer = 2000;
            
            try {
                while (hasNewerData && loadedCount < targetBuffer) {
                    const afterTs = newestTimestamp * 1000;
                    const url = `/api/candlesticks/?symbol=${currentSymbol}&bar=${currentBar}&limit=500&source=${currentSource}&after=${afterTs}`;
                    const response = await fetch(url);
                    const result = await response.json();
                    
                    if (result.code === 0 && result.data && result.data.length > 0) {
                        const newCandles = result.data;
                        
                        const existingTimes = new Set(allCandles.map(c => c.time));
                        const uniqueNewCandles = newCandles.filter(c => !existingTimes.has(c.time));
                        
                        if (uniqueNewCandles.length > 0) {
                            allCandles = [...allCandles, ...uniqueNewCandles];
                            allCandles.sort((a, b) => a.time - b.time);
                            newestTimestamp = allCandles[allCandles.length - 1].time;
                            loadedCount += uniqueNewCandles.length;
                            
                            updateChartData();
                        } else {
                            hasNewerData = false;
                            break;
                        }
                        
                        if (newCandles.length < 500) {
                            hasNewerData = false;
                            break;
                        }
                    } else {
                        hasNewerData = false;
                        break;
                    }
                }
                
                console.log(`æœ€æ–°æ•°æ®åŠ è½½å®Œæˆï¼Œå…±åŠ è½½ ${loadedCount} æ¡ï¼Œæ€»æ•°æ®é‡ ${allCandles.length} æ¡`);
            } catch (error) {
                console.error('æŒç»­åŠ è½½æ›´æ–°æ•°æ®å¤±è´¥:', error);
            } finally {
                isLoadingNewer = false;
            }
        }
        
        // æ›´æ–°å›¾è¡¨æ•°æ®çš„é€šç”¨å‡½æ•°
        function updateChartData() {
            const colors = getColors();
            candleSeries.setData(allCandles);
            const volumeData = allCandles.map(c => ({
                time: c.time,
                value: c.volume,
                color: c.close >= c.open ? colors.upTransparent : colors.downTransparent,
            }));
            volumeSeries.setData(volumeData);
        }

        // æ˜¾ç¤ºé”™è¯¯
        function showError(message) {
            document.getElementById('error-message').textContent = message;
            document.getElementById('error-banner').classList.add('show');
        }

        // éšè—é”™è¯¯
        function hideError() {
            document.getElementById('error-banner').classList.remove('show');
        }

        // æ˜¾ç¤ºå›¾è¡¨åŒºåŸŸé”™è¯¯
        function showChartError(message, detail) {
            const container = document.getElementById('chart-container');
            container.innerHTML = `
                <div class="chart-error">
                    <div class="error-icon">âŒ</div>
                    <div class="error-title">${message}</div>
                    <div class="error-detail">${detail}</div>
                    <button class="retry-btn" onclick="retryLoad()">ğŸ”„ é‡è¯•</button>
                </div>
            `;
        }

        // é‡è¯•åŠ è½½
        function retryLoad() {
            hideError();
            initChart();
            refreshData();
        }

        // åŠ è½½ K çº¿æ•°æ®
        async function loadCandlesticks() {
            try {
                const response = await fetch(`/api/candlesticks/?symbol=${currentSymbol}&bar=${currentBar}&limit=100&source=${currentSource}`);
                const result = await response.json();
                
                if (result.code === 0 && result.data) {
                    hideError();
                    const candles = result.data;
                    
                    // ä¿å­˜åˆ°ç¼“å­˜
                    allCandles = candles;
                    if (candles.length > 0) {
                        oldestTimestamp = candles[0].time;
                        newestTimestamp = candles[candles.length - 1].time;
                        hasMoreData = true;
                        hasNewerData = true;
                    }
                    
                    candleSeries.setData(candles);

                    const colors = getColors();
                    // æˆäº¤é‡æ•°æ®
                    const volumeData = candles.map(c => ({
                        time: c.time,
                        value: c.volume,
                        color: c.close >= c.open ? colors.upTransparent : colors.downTransparent,
                    }));
                    volumeSeries.setData(volumeData);

                    chart.timeScale().fitContent();
                } else {
                    // API è¿”å›é”™è¯¯
                    const errorMsg = result.error || 'Kçº¿æ•°æ®åŠ è½½å¤±è´¥';
                    showError(`Kçº¿æ•°æ®é”™è¯¯: ${errorMsg}`);
                    showChartError('Kçº¿æ•°æ®åŠ è½½å¤±è´¥', errorMsg);
                }
            } catch (error) {
                console.error('åŠ è½½Kçº¿å¤±è´¥:', error);
                showError(`ç½‘ç»œé”™è¯¯: ${error.message}`);
                showChartError('æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨', error.message);
            }
        }

        // åŠ è½½è¡Œæƒ…
        async function loadTicker() {
            try {
                const response = await fetch(`/api/ticker/?symbol=${currentSymbol}&source=${currentSource}`);
                const result = await response.json();
                
                if (result.code === 0 && result.data) {
                    const ticker = result.data;
                    const lastPrice = parseFloat(ticker.last);
                    const open24h = parseFloat(ticker.open24h);
                    const changePercent = ((lastPrice - open24h) / open24h * 100).toFixed(2);
                    const isUp = lastPrice >= open24h;

                    document.getElementById('last-price').textContent = lastPrice.toLocaleString();
                    document.getElementById('last-price').className = `ticker-value ${isUp ? 'up' : 'down'}`;

                    document.getElementById('change-24h').textContent = `${isUp ? '+' : ''}${changePercent}%`;
                    document.getElementById('change-24h').className = `ticker-value ${isUp ? 'up' : 'down'}`;

                    document.getElementById('high-24h').textContent = parseFloat(ticker.high24h).toLocaleString();
                    document.getElementById('low-24h').textContent = parseFloat(ticker.low24h).toLocaleString();
                    document.getElementById('volume-24h').textContent = parseFloat(ticker.vol24h).toLocaleString();
                } else {
                    // API è¿”å›é”™è¯¯
                    const errorMsg = result.error || 'è¡Œæƒ…æ•°æ®åŠ è½½å¤±è´¥';
                    showError(`è¡Œæƒ…é”™è¯¯: ${errorMsg}`);
                    // æ¸…ç©ºè¡Œæƒ…æ˜¾ç¤º
                    document.getElementById('last-price').textContent = '--';
                    document.getElementById('change-24h').textContent = '--';
                    document.getElementById('high-24h').textContent = '--';
                    document.getElementById('low-24h').textContent = '--';
                    document.getElementById('volume-24h').textContent = '--';
                }
            } catch (error) {
                console.error('åŠ è½½è¡Œæƒ…å¤±è´¥:', error);
                showError(`è¡Œæƒ…ç½‘ç»œé”™è¯¯: ${error.message}`);
            }
        }

        // åˆ·æ–°æ•°æ®
        function refreshData() {
            loadCandlesticks();
            loadTicker();
        }

        // äº‹ä»¶ç»‘å®š
        document.getElementById('symbol-select').addEventListener('change', (e) => {
            currentSymbol = e.target.value;
            refreshData();
        });

        document.getElementById('source-select').addEventListener('change', (e) => {
            currentSource = e.target.value;
            refreshData();
        });

        document.querySelectorAll('.timeframe-buttons button').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.timeframe-buttons button').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentBar = btn.dataset.bar;
                document.getElementById('more-timeframes').value = '';
                document.getElementById('custom-interval').style.display = 'none';
                refreshData();
            });
        });
        
        // æ›´å¤šå‘¨æœŸä¸‹æ‹‰èœå•
        document.getElementById('more-timeframes').addEventListener('change', (e) => {
            const value = e.target.value;
            if (!value) return;
            
            if (value === 'custom') {
                // æ˜¾ç¤ºè‡ªå®šä¹‰è¾“å…¥æ¡†
                document.getElementById('custom-interval').style.display = 'block';
                document.getElementById('custom-interval').focus();
            } else {
                // é€‰æ‹©é¢„è®¾å‘¨æœŸ
                document.querySelectorAll('.timeframe-buttons button').forEach(b => b.classList.remove('active'));
                currentBar = value;
                document.getElementById('custom-interval').style.display = 'none';
                refreshData();
            }
        });
        
        // è‡ªå®šä¹‰å‘¨æœŸè¾“å…¥
        document.getElementById('custom-interval').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const customValue = e.target.value.trim().toUpperCase();
                if (customValue) {
                    // éªŒè¯æ ¼å¼ï¼šæ•°å­— + å•ä½ (å¦‚: 2H, 7D, 90m)
                    const match = customValue.match(/^(\d+)([SMHDW])$/);
                    if (match) {
                        document.querySelectorAll('.timeframe-buttons button').forEach(b => b.classList.remove('active'));
                        currentBar = customValue.toLowerCase();
                        refreshData();
                    } else {
                        alert('æ ¼å¼é”™è¯¯ï¼è¯·ä½¿ç”¨æ ¼å¼ï¼šæ•°å­—+å•ä½\\nä¾‹å¦‚ï¼š2H (2å°æ—¶), 7D (7å¤©), 90m (90åˆ†é’Ÿ)\\nå•ä½ï¼šs(ç§’) m(åˆ†) H(æ—¶) D(æ—¥) W(å‘¨)');
                    }
                }
            }
        });

        document.getElementById('refresh-btn').addEventListener('click', refreshData);

        // è®¾ç½®åˆå§‹é€‰ä¸­çŠ¶æ€
        document.getElementById('symbol-select').value = currentSymbol;
        document.getElementById('source-select').value = currentSource;
        document.querySelectorAll('.timeframe-buttons button').forEach(btn => {
            if (btn.dataset.bar === currentBar) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });

        // åˆå§‹åŒ–
        initChart();
        refreshData();

        // å®šæ—¶åˆ·æ–°ï¼ˆæ¯30ç§’ï¼‰
        setInterval(refreshData, 30000);
    </script>
</body>
</html>
